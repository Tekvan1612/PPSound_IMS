{% include 'product_tracking/head.html' %}
{% load static %}
{% block content %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .container-popup {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header-popup {
            background-color: #0e0a0a;
            padding: 1px;
            border-bottom: 1px solid #ddd;

        }

        .header-popup h1 {
            margin: 0;
            font-size: 12px;
        }

        .content-popup {
            flex: 1;
            padding: 0px;
            background-color: #0e0a0a;
            border: 1px solid #ddd;
            height: 420px; /* Set your desired fixed height here */
            overflow-y: auto; /* Add vertical scrollbar if content exceeds the height */
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            text-align: left;
            padding: 2px;
            border: 1px solid #ddd;
            font-size: 12px;
            color: #FFFFFF;
        }

        th {
            background-color: #0c0c0c;
            color: #FFFFFF;
        }

        .footer-popup {
            padding: 1px;
            border-top: 1px solid #ddd;
            background-color: #0c0c0c;
            color: #FFFFFF;
        }

        .search-bar {
            margin-left: 0px;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 75%;
        }


        /* Popup container */
        .popup {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Black background with transparency */
        }

        /* Popup content */
        .popup-content {
            background-color: #fff;
            margin: 4% auto;
            border: 1px solid #ddd;
            width: 80%;
            max-width: 400px;
            height: 80%;
            max-height: 800px;
        }

        .popup-content .header {
            background-color: #f2f2f2;
        }

        /* Ensure the parent container is positioned relatively */
        .col-auto.ms-auto {
            position: relative;
        }

        /* Position the dropdown menu to the right of the parent container */
        #dropdown-container {
            right: 10px; /* Aligns the right edge of the dropdown to the right edge of the parent container */
            top: 100%; /* Positions it below the button, adjust if necessary */
            /* Optionally add additional styling for spacing or alignment */
            margin-top: 5px; /* Space between the button and dropdown */
        }


        #quotation-type-dropdown {
            width: 100%; /* Make the select full width */
            border: 1px solid #ccc; /* Border for the select element */
            border-radius: 4px; /* Rounded corners for the select element */
            padding: 5px; /* Padding inside the select element */
            font-size: 14px; /* Font size for readability */
        }

        #quotation-type-dropdown option {
            padding: 5px; /* Padding inside each option */
        }

        .crew-left-content {
            border: 2px solid grey;
            width: 30%;
            border-radius: 7px;
            margin-right: 43px;
            padding: 10px;

        }

        .crew-right-content {
            border: 2px solid grey;
            border-radius: 7px;
            width: 70%;
            padding: 10px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .right-equipment-container {
            margin: 5px auto;
            border: 1px solid #ccc;
            border-radius: 10px;
        {#background-color: white;#} padding: 15px; /* Optional: add padding for better spacing inside the container */
        }

        .left-equipment-container {
            margin: 10px auto;
            border: 1px solid #ccc;
            border-radius: 10px;
        {#background-color: white;#} padding: 15px; /* Optional: add padding for better spacing inside the container */
        }


        .accordion-header {
            background-color: #f7f7f7;
            padding: 0px;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between; /* Distributes space between equipment name and button */
            align-items: center; /* Aligns items vertically in the center */
        }

        .equipment-heading {
            margin-left: 11px;
        }

        .equipment-item {
            flex-grow: 1; /* Ensures the name takes up the available space */
            margin-left: 21px;
        }

        .plus-btn {
            margin-left: auto; /* Pushes the button to the far right */
        }

        .accordion-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .accordion-content {
            padding: 10px;
            display: none;
        }

        .accordion-content.open {
            display: block;
        }

        .quantity-container {
            display: flex;
            flex-direction: column; /* Stacks items vertically */
            gap: 10px; /* Adds space between items */
        }

        .subcategory-item {
            display: flex;
            align-items: center; /* Aligns text and button in a row */
        }

        .subcategory-item span {
            margin-right: 10px; /* Adds space between text and button */
        }

        .is-invalid {
            border-color: red;
        }

        .input-container {
            position: relative;
            display: inline-block;
            flex: 1;
        }

        #equipmentDropdown {
            position: absolute;
            top: 100%; /* Position below the search box */
            left: 0;
            z-index: 1000; /* Ensure it appears above other content */
            width: 100%; /* Match the width of the search box */
            max-height: 300px; /* Limit height to avoid overflow */
            overflow-y: auto; /* Add scrollbar if needed */
        {#background: #fff; /* Background color */#} border: 1px solid #ddd; /* Border color */
            border-radius: 0.25rem; /* Rounded corners */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Drop shadow */
        }

        .table {
            margin-bottom: 0; /* Remove bottom margin */
        }

        .table thead th {
        {#background-color: #f8f9fa; /* Light background for header */#} color: #495057; /* Dark text color */
            font-weight: bold; /* Bold text */
        }

        .table tbody tr:hover {
        {#background-color: #f1f1f1; /* Highlight row on hover */#}
        }

        .table td {
            vertical-align: middle; /* Center content vertically */
            padding-right: 6px;
        }

        .quantity-input {
            width: 100px; /* Fixed width for input fields */
        }

        .disabled-option {
        {#background-color: #e9ecef; /* Light gray background for disabled rows */#} color: #6c757d; /* Gray text color */
        }

        .table-container {
            max-height: 430px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
        {#background-color: #f9f9f9;#} border-radius: 5px;
        }

        .table {
            width: 100%;
            margin-bottom: 0;
        }

        .table thead {
            background-color: #343a40;
            color: #fff;
        }

        .table tbody tr td {
            vertical-align: middle;
        }

        .table tbody tr td input[type="number"] {
            width: 80px;
            text-align: center;
        }

        .table tbody tr td .delete-btn {
            color: #dc3545;
            cursor: pointer;
        }

        .table tbody tr td .delete-btn:hover {
            color: #a71d2a;
        }

        .table-striped tbody tr:nth-of-type(odd) {
        {#background-color: #f2f2f2;#}
        }

        .table-bordered {
            border: 1px solid #dee2e6;
        }


        .search-container {
            display: flex;
            align-items: center; /* Align items vertically center */
            justify-content: space-between; /* Space between the items */
            margin-bottom: 10px; /* Space below the search container */
            width: 100%;
        }

        .quantity-container {
            display: flex;
        {#align-items: center; /* Center the quantity input vertically */#} margin-bottom: 10px; /* Space below the quantity input */
            margin-top: 10px;
        {#margin-left: 24px;#}
        }

        .table-container {
            margin-top: 3px; /* Adjust as needed */
        }

        .custom-table {
            width: 100%; /* Ensure table takes full width of its container */
            border-collapse: collapse;
        }

        .custom-table th, .custom-table td {
            text-align: left; /* Align text to the left */
            padding: 1px; /* Padding for table cells */
            padding-left: 12px;
        }

        .custom-table th {
        {#background-color: #f2f2f2; /* Background color for header */#}
        }

        body {
            font-family: Arial, sans-serif;
        }

        .form-container {
            width: 100%;
            max-width: 100%;
            height: 100%;
            max-height: 100%;
            margin: 0px auto;
            padding: 0 20px 20px 20px;
        }

        .step-buttons {
            text-align: center;
            margin-bottom: 15px;
            margin-left: -20px;
        {#border-top: 1px solid #E6E6E6;#} margin-right: -20px;
        }

        .step-btn {
            position: relative;
            padding: 10px 20px;
            margin: 20px 0 0 0;
            border: none;
            border-radius: 25px;
            background-color: #0d99ff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .step-btn:hover {
            background-color: #0056b3;
        }

        .step-btn.active {
            background-color: green;
        }

        .step-btn:not(:last-child) {
            margin-right: 16px;
        }

        .step-btn:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -20px;
            width: 21px;
            height: 2px;
            background-color: #0d99ff;
            z-index: 1;
            transform: translateY(-50%);
        }

        .step-btn.active::after {
            background-color: green; /* Line color when the button is active */
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        .custom-width {
            width: 151px;
        }

        .form-job {
            font-size: 1rem;
            font-weight: 500;
            color: #0c0c0c;
        }

        .venue-address-item {
            width: 500px;
            white-space: normal;
            word-wrap: break-word;
            display: block;
        }

        {#label {#}
        {#    display: block;#}
        {#    margin-top: 10px;#}
        {# }#}

        input {
            width: 100%;
        {#padding: 10px;#} margin-top: 5px;
            box-sizing: border-box;
        }

        /* Media Queries */
        @media (max-width: 768px) {
            .step-buttons {
                flex-direction: column;
            }

            .step-btn:not(:last-child) {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .custom-width {
                width: 100%; /* Full width on small screens */
                max-width: none;
            }

        {#.venue-address-item {#}
        {#    width: 100%;#}
        {# }#}
        }

        @media (max-width: 400px) {
            .form-container {
                width: 95%;
                padding: 15px;
            }

            .step-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            input {
                padding: 8px;
            }
        }
    </style>
    <script>
        function validateStep(currentStep, nextStep) {
            const currentStepInputs = document.querySelectorAll(`#step-${currentStep} input[required], #step-${currentStep} select[required]`);

            let valid = true;

            currentStepInputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    valid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            if (valid) {
                showStep(nextStep);
            } else {
                alert("Please fill in all required fields before proceeding.");
            }
        }

        function showStep(step) {
            document.querySelectorAll('.form-step').forEach(stepElement => {
                stepElement.style.display = 'none';
            });
            document.getElementById(`step-${step}`).style.display = 'block';
        }

        // Ensure the first step is always active on page load
        window.onload = function () {
            showStep(1);
        }

        $(document).ready(function () {
            fetchClientName();
            fetchVenueAddress();
            fetchVenueName();

            // General Details Section
            // Call this function on page load with the initial status value
            var initialStatus = $('#statusType').val();
            updateFieldsBasedOnStatus(initialStatus);

            function getJobIdFromURL() {
                var url = window.location.href;
                var urlObj = new URL(url);
                var pathSegments = urlObj.pathname.split('/');
                var jobIdIndex = pathSegments.indexOf('edit_job') + 1;
                return jobIdIndex > 0 ? pathSegments[jobIdIndex] : null;
            }

            var jobId = getJobIdFromURL(); // Implement this function to get jobId from the URL
            console.log('Fetch the jobId:', jobId);

            let fetchedStatus; // Declare a variable to hold the status

            if (jobId) {
                $.ajax({
                    url: `/get_temp_details/${jobId}/`,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        if (data.error) {
                            console.log(data.error);
                        } else {
                            console.log('Fetch the DATA:', data);
                            // Populate form fields with data from the response
                            $('#titleInput').val(data.title);
                            $('#clientNameDropdown').val(data.client_name);
                            $('#clientContactName').val(data.contact_person_name);
                            $('#clientContactNumber').val(data.contact_person_number);
                            $('#statusType').val(data.status);
                            $('#crewQuantity').val(data.crew_type);
                            $('#venueAddressDropdown').val(data.venue_name);
                            $('#venueAddressInput').val(data.venue_address);
                            $('#editInputNotes').val(data.notes);
                            $('#prepDate').val(data.setup_date);
                            $('#outDate').val(data.rehearsal_date);
                            $('#showStart').val(data.event_date);
                            $('#showEnd').val(data.dismantle_date);
                            $('#number_of_days').val(data.total_days);
                            $('#total_amount').val(data.amount_row);
                            $('#discount').val(data.discount);
                            $('#discounted_amount').val(data.amount_after_discount);
                            $('#total_amount_cal').val(data.total_amount);
                            console.log('Fetch the details:', data.status);
                            console.log('Fetch the notes details:', data.notes)

                            // Store the fetched status
                            fetchedStatus = data.status; // Set the fetched status

                            // Handle employee_name, assuming it's a comma-separated string
                            console.log('Original employee data:', data.employee);
                            const employeeName = data.employee ? data.employee.split(',').map(name => name.trim()) : [];
                            console.log('employeeNames show:', employeeName);
                            $('#employeeName').val(employeeName).trigger('change');

                            // Call the function to update fields based on the fetched status
                            updateFieldsBasedOnStatus(fetchedStatus);

                            // Show/hide fields based on the fetched status
                            updateFieldsBasedOnStatus(fetchedStatus); // Call the function here

                            // Fetch individual names for the client
                            fetchIndividualNames(data.contact_person_name);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log('AJAX Error: ' + status + error);
                    }
                });
            }

            function fetchEmployeeNames() {
                $.ajax({
                    url: '/get_employee_name/',
                    type: 'GET',
                    success: function (response) {
                        var employeeDropdown = $('#employeeName');
                        employeeDropdown.empty(); // Clear existing options
                        employeeDropdown.append('<option value="" data-display="Select">Select</option>');

                        // Populate the dropdown with new options
                        response.employee_names.forEach(function (employee) {
                            employeeDropdown.append('<option value="' + employee.name + '">' + employee.name + '</option>');
                        });

                        // Process and set existing values
                        const fetchedEmployeeData = employeeNames; // This should come from your actual data source
                        const employeeNames = processEmployeeData(fetchedEmployeeData);

                        // Set the selected values
                        if (employeeNames.length > 0) {
                            $('#employeeName').val(employeeNames).trigger('change');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Failed to fetch employee names:', error);
                    }
                });
            }

            function processEmployeeData(employeeData) {
                return employeeData.replace(/\n/g, '').split(',').map(name => name.trim());
            }

            // Call fetchEmployeeNames to populate the dropdown
            fetchEmployeeNames();

            function fetchClientName() {
                $.ajax({
                    url: '/fetch_client_name/',
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        var clientNames = data.client_names;
                        var dropdownMenu = $('#clientNameDropdown').next('.dropdown-menu');
                        dropdownMenu.empty();

                        $.each(clientNames, function (index, client) {
                            dropdownMenu.append('<li><a class="dropdown-item client-name-item" href="#" data-client-name="' + client.name + '" data-client-type="' + client.type + '">' + client.name + '</a></li>');
                            console.log('name', client.name, client.type);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching client names:', error);
                    }
                });
            }

            $('#clientNameDropdown').on('input', function () {
                var filter = $(this).val().toLowerCase();
                $('#clientNameInputDropdown li').each(function () {
                    var text = $(this).text().toLowerCase();
                    $(this).toggle(text.indexOf(filter) > -1);
                });
            });

            function fetchIndividualNames(clientName) {
                $.ajax({
                    url: '/fetch_individual_names/',
                    type: 'GET',
                    data: {client_name: clientName},
                    dataType: 'json',
                    success: function (data) {
                        var individualNames = data.individual_names;
                        var contactDropdown = $('#clientContactName');
                        contactDropdown.empty(); // Ensure dropdown is empty before adding options

                        // Add options to the dropdown
                        $.each(individualNames, function (index, person) {
                            contactDropdown.append('<option value="' + person.name + '" data-mobile="' + person.mobile + '">' + person.name + '</option>');
                        });

                        // Optionally, trigger change event if needed
                        contactDropdown.trigger('change');
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching individual names:', error);
                    }
                });
            }

            $(document).on('change', '#clientContactName', function () {
                var selectedOption = $(this).find('option:selected');
                var mobileNumber = selectedOption.data('mobile');
                $('#clientContactNumber').val(mobileNumber);
            });

            $(document).on('click', '.client-name-item', function () {
                var clientName = $(this).data('client-name');
                var clientType = $(this).data('client-type');
                var input = $(this).closest('.dropdown').find('.dropdown-toggle');
                input.val(clientName);
                input.dropdown('toggle');
                // Fetch and populate individual names based on selected client
                fetchIndividualNames(clientName);
            });

            $('#venueAddressDropdown').on('keyup', function () {
                var query = $(this).val();
                if (query.length > 0) {  // Start searching after a few characters
                    fetchVenueName(query);
                } else {
                    $('#dropdown-item').empty(); // Clear the dropdown if input is empty
                }
            });

            $(document).on('click', '.venue-name-item', function (e) {
                e.preventDefault();
                var venueName = $(this).data('venue-name');
                $('#venueAddressDropdown').val(venueName);  // Set the selected venue name in the input
                fetchVenueAddress(venueName);  // Fetch the corresponding venue address
                $('#dropdown-item').empty();  // Clear the dropdown after selection
            });

            function fetchVenueName(query) {
                $.ajax({
                    url: '/fetch_venue_name/',  // Your Django view URL for fetching venue names
                    type: 'GET',
                    data: {'query': query},  // Pass the query to the server
                    dataType: 'json',
                    success: function (data) {
                        var venueNames = data.venue_names;
                        var dropdownMenu = $('#dropdown-item');
                        dropdownMenu.empty();  // Clear the dropdown before appending new data

                        $.each(venueNames, function (index, venue) {
                            dropdownMenu.append('<li><a class="dropdown-item venue-name-item" href="#" data-venue-name="' + venue.name + '">' + venue.name + '</a></li>');
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching venue names:', error);
                    }
                });
            }

            function fetchVenueAddress(venueNames) {
                $.ajax({
                    url: '/fetch_venue_address/',  // Your Django view URL for fetching venue addresses
                    type: 'GET',
                    data: {'venue_name': venueNames},  // Pass the selected venue name to the server
                    dataType: 'json',
                    success: function (data) {
                        if (data.venue_address) {
                            $('#venueAddressInput').val(data.venue_address);  // Set the venue address in the input
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching venue address:', error);
                    }
                });
            }

            $('#venueAddressDropdown').on('keyup', function () {
                var value = $(this).val().toLowerCase();
                var dropdownMenu = $(this).next('.dropdown-menu');
                dropdownMenu.children('.dropdown-item').filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Function to update fields based on status value
            function updateFieldsBasedOnStatus(status) {
                console.log('check the status of update field based status:', status)
                if (status === "Quotation") {
                    $('#vehicle-number-field').hide();
                    $('#quotation-fields').show();
                    $('#quotation-details').show();
                    $('#quotation-fields1').show();
                    $('#crew-allocation-delivery-challan').hide();
                    $('#crew-allocation-quotation').show();
                    $('#prepsheet-fields').hide();
                    $('#nav-general_details').show();
                    $('#general_Information').show();
                    $('#nav-crew_allocation').hide();
                    $('#nav-transportation_allocation').hide();
                    $('#nav-add_sub_vendor').hide();

                } else if (status === "Proforma") {
                    $('#quotation-fields1').show();
                    $('#crew-allocation-delivery-challan').hide();
                    $('#crew-allocation-quotation').show();
                    $('#quotation-fields').hide();
                    $('#prepsheet-fields').hide();
                    $('#nav-general_details').show();
                    $('#nav-add_equipment').show();
                    $('#nav-add_sub_vendor').hide();
                    $('#nav-crew_allocation').hide();
                    $('#nav-transportation_allocation').hide();
                    $('.vehicle-number-field').hide();
                } else if (status === "Prepsheet") {
                    $('#quotation-fields').hide();
                    $('#prepsheet-fields').show();
                    $('#quotation-fields1').hide();
                    $('#crew-allocation-delivery-challan').show();
                    $('#crew-allocation-quotation').hide();
                    $('#nav-general_details').show();
                    $('#nav-add_equipment').show();
                    $('#nav-add_sub_vendor').show();
                    $('#nav-crew_allocation').show();
                    $('#nav-transportation_allocation').show();
                    $('.vehicle-number-field').show();
                    fetchEmployeeNames();
                    fetchCrewAllocation(jobId);
                } else {
                    $('#quotation-fields').hide();
                    $('#crew-allocation-quotation').hide();
                    $('#prepsheet-fields').hide();
                    $('#quotation-fields1').hide();
                    $('#nav-general_details').show();
                    $('#nav-add_equipment').show();
                    $('#nav-add_sub_vendor').show();
                    $('#nav-crew_allocation').show();
                    $('#nav-transportation_allocation').show();
                    $('#crew-allocation-delivery-challan').show();
                    $('.vehicle-number-field').show();
                    fetchCrewAllocation(jobId);
                }
            }

            // Event handler for status change
            $('#statusType').change(function () {
                var selectedValue = $(this).val();
                updateFieldsBasedOnStatus(selectedValue);
            });

            $('#showStart').change(function () {
                var startDate = $(this).val();
                $('#showEnd').attr('min', startDate);
                validateDates();
            });

            $('#showEnd').change(function () {
                validateDates();
            });

            function validateDates() {
                var showStartDate = $('#showStart').val();
                var showEndDate = $('#showEnd').val();

                if (showStartDate && showEndDate) {
                    if (new Date(showEndDate) < new Date(showStartDate)) {
                        alert("Select a valid date. Show End Date cannot be before Show Start Date.");
                        $('#showEnd').val('');
                        $('#number_of_days').val('');  // Clear number_of_days if dates are invalid
                    }
                }
            }

            function updateTempDetails() {
                var jobId = getJobIdFromURL(); // Implement this function to get jobId from the URL

                var employeeName = $('#employeeName').val(); // Get the selected crew types as an array
                var employeeNameString = employeeName.join(', ');

                var formData = {
                    status: $('#statusType').val(),
                    title: $('#titleInput').val(),
                    client_name: $('#clientNameDropdown').val(),
                    contact_person_name: $('#clientContactName').val(),
                    contact_person_number: $('#clientContactNumber').val(),
                    crew_quantity: $('#crewQuantity').val(),
                    employee_name: employeeNameString, // Use the comma-separated string
                    venue_name: $('#venueAddressDropdown').val(),
                    venue_address: $('#venueAddressInput').val(),
                    input_notes: $('#editInputNotes').val(),
                    setup_date: $('#prepDate').val(),
                    rehearsal_date: $('#outDate').val(),
                    event_date: $('#showStart').val(),
                    dismantle_date: $('#showEnd').val(),
                    total_days: $('#number_of_days').val(),
                    amount_row: $('#total_amount').val(),
                    discount: $('#discount').val(),
                    amount_after_discount: $('#discounted_amount').val(),
                    total_amount: $('#total_amount_cal').val(),
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                };

                $.ajax({
                    url: `/update_temp_details/${jobId}/`,
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            console.log('Details updated successfully');

                        } else {
                            console.log('Error updating details');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log('AJAX Error: ' + status + error);
                    }
                });
            }

            $('#step-1').on('input', 'input', function () {
                // Check if the input field is NOT the venueAddressDropdown
                if ($(this).attr('id') !== 'venueAddressDropdown') {
                    updateTempDetails();
                }
            });

            // Initialize Select2
            $('#employeeName').select2({
                placeholder: "Select Employee Name",
                allowClear: true,
                multiple: true
            });

            // Call this function when the form is submitted or when the status is changed
            $('#statusType').change(function () {
                var status = $(this).val();

                if (status === 'Quotation') {
                    updateTempDetails();
                } else if (status === 'Proforma') {
                    updateTempDetails();
                } else if (status === 'Prepsheet') {
                    updateTempDetails();
                } else {
                    updateTempDetails();
                }

            });

            // Status dropdown change event
            $('#statusType').change(function () {
                var selectedValue = $(this).val();

                // Show/hide fields based on status
                if (selectedValue === "Quotation") {
                    $('#quotation-fields').show();
                    $('#quotation-details').show();
                    $('#quotation-fields1').show();
                    $('#crew-allocation-delivery-challan').hide();
                    $('#crew-allocation-quotation').show();
                    $('#prepsheet-fields').hide();
                    $('#nav-general_details').show();
                    $('#general_Information').show();
                    $('#nav-crew_allocation').hide();
                    $('#nav-transportation_allocation').hide();
                    $('#nav-add_sub_vendor').hide();
                } else if (selectedValue === "Proforma") {
                    $('#quotation-fields1').show();
                    $('#crew-allocation-delivery-challan').hide();
                    $('#crew-allocation-quotation').show();
                    $('#quotation-fields').hide();
                    $('#prepsheet-fields').hide();
                    $('#nav-general_details').show();
                    $('#nav-add_equipment').show();
                    $('#nav-add_sub_vendor').hide();
                    $('#nav-crew_allocation').hide();
                    $('#nav-transportation_allocation').hide();
                } else if (selectedValue === "Prepsheet") {
                    $('#quotation-fields').hide();
                    $('#prepsheet-fields').show();
                    $('#quotation-fields1').hide();
                    $('#crew-allocation-delivery-challan').show();
                    $('#crew-allocation-quotation').hide();
                    $('#nav-general_details').show();
                    $('#nav-add_equipment').show();
                    $('#nav-add_sub_vendor').show();
                    $('#nav-crew_allocation').show();
                    $('#nav-transportation_allocation').show();
                    fetchEmployeeNames();
                } else {
                    $('#quotation-fields').hide();
                    $('#crew-allocation-quotation').hide();
                    $('#prepsheet-fields').hide();
                    $('#quotation-fields1').hide();
                    $('#nav-general_details').show();
                    $('#nav-add_equipment').show();
                    $('#nav-add_sub_vendor').show();
                    $('#nav-crew_allocation').show();
                    $('#nav-transportation_allocation').show();
                    $('#crew-allocation-delivery-challan').show();
                }
            });

            calculateTotalAmount(jobId);

            // Function to calculate the total amount
            function calculateTotalAmount(jobId) {
                $.ajax({
                    url: `/calculate-total-amount/${jobId}/`, // Django URL pattern
                    type: 'GET',
                    success: function (response) {
                        console.log('check the equipment calculate total AMOUNT:', response)
                        // Update the total amount in the input field
                        $('#total_amount').val(response.total_amount);

                        calculateAmounts();
                    },
                    error: function (error) {
                        console.error('Error fetching total amount:', error);
                    }
                });
            }

            // Function to calculate discount and total amounts
            function calculateAmounts() {
                // Get the values of the total amount and discount
                var totalAmount = parseFloat($('#total_amount').val());
                var discount = parseFloat($('#discount').val());

                // Check if both totalAmount and discount are numbers
                if (!isNaN(totalAmount) && !isNaN(discount)) {
                    // Calculate the discounted amount
                    var discountedAmount = totalAmount - (totalAmount * discount / 100);
                    $('#discounted_amount').val(discountedAmount);

                    // Calculate the total amount with GST
                    var totalAmountWithGST = discountedAmount * 1.18;
                    $('#total_amount_cal').val(Math.round(totalAmountWithGST));
                }
            }

            // Trigger the calculation when the discount value changes
            $('#discount').on('input', function () {
                calculateAmounts();
            });

            // You can also trigger the calculation when the total amount changes
            $('#total_amount').on('input', function () {
                calculateAmounts();
            });

            // Equipment Details Section
            if (jobId) {
                // Fetch the job reference number using tempId
                $.ajax({
                    url: '/fetch-job-reference-no/',  // Endpoint to fetch the job reference number
                    type: 'GET',
                    data: {temp_id: jobId},  // Send tempId as query parameter
                    success: function (response) {
                        if (response.status === 'success') {
                            // Update the job reference number in the #jobReferenceNo span
                            $('#jobReferenceNo').text(response.job_reference_no + ' - ' + response.title);
                            console.log('Fetched Job Reference No:', response.job_reference_no);
                        } else {
                            console.log('Error fetching job reference number:', response.error);
                        }
                    },
                    error: function (error) {
                        console.log('Error in AJAX request:', error);
                    }
                });
            }

            // when clicking on the Job Reference No
            $('#job-J06240001').on('click', function () {
                const heading = $(this).find('.equipment-heading'); // Dynamically find the equipment heading inside the clicked element
                heading.toggle(); // Show or hide the equipment heading

                // Change the sign from + to - and vice versa
                const sign = heading.find('.toggle-sign'); // Find the element with the toggle sign within the heading
                sign.text(sign.text() === '+' ? '-' : '+'); // Toggle between + and -
            });

            // Toggle sub-equipment details when clicking on the equipment name
            $('#heading-J06240001').on('click', function () {
                const equipmentList = $('#equipment-list-J06240001, #rightEquipment'); // Get the equipment list
                equipmentList.toggle(); // Show or hide the equipment list

                // Change the sign from + to - and vice versa
                const sign = $(this).children('.toggle-sign');
                sign.text(sign.text() === '+' ? '-' : '+');
            });

            // change from this start 24/10/2024
            // Declare equipmentDetailId globally
            let equipmentDetailId;

            if (jobId) {
                console.log('Fetching equipment detail IDs for jobId:', jobId);

                $.ajax({
                    url: '/fetch-equipment-detail-id/',  // Replace with your correct URL
                    method: 'GET',
                    data: {
                        jobId: jobId  // Pass the jobId to the server
                    },
                    success: function (response) {
                        console.log('Check the response of equipment details TABLE:', response);
                        const equipmentDetailIds = response.equipment_detail_ids;
                        console.log('Check the equipment details ID:', equipmentDetailIds);

                        if (equipmentDetailIds.length > 0) {
                            // Sort the IDs alphabetically
                            equipmentDetailIds.sort();

                            let equipmentContainer = $('#equipmentContainer');  // Target the span element

                            // Add a "+" before each id and wrap it in a span with a click event
                            let idsDisplay = equipmentDetailIds.map(id =>
                                `<span class="equipment-plus-sign" data-equip-id="${id}" style="cursor: pointer;"> +</span><span class="equipment-id" data-equip-id="${id}" style="cursor: pointer;"> ${id}</span>`
                            ).join('<br>');

                            console.log('Check the equipment ID:', idsDisplay);
                            equipmentContainer.html(idsDisplay);  // Use .html() to render <br> tags
                            console.log('Check the equipment ID:', equipmentContainer);

                            // Attach click event to each equipment ID
                            $('.equipment-id').on('click', function () {
                                equipmentDetailId = $(this).data('equip-id');  // Get the ID from data attribute
                                console.log('Check the equipment ID:', equipmentDetailId);

                                // Reset the font-weight of all equipment IDs
                                $('.equipment-id').css('font-weight', 'normal');  // Reset all to normal

                                // Highlight the first equipment by default
                                $(`.equipment-id[data-equip-id='${equipmentDetailId}']`).css('font-weight', 'bold');  // Highlight default

                                // Automatically call the second AJAX to fetch equipment details
                                fetchEquipmentDetails(equipmentDetailId);  // Re-use the AJAX call as a function
                            });

                            // Show details for the first equipment by default
                            const firstEquipmentId = equipmentDetailIds[0];  // Get the first ID
                            console.log('Fetching details for the first equipment ID:', firstEquipmentId);

                            // Assign firstEquipmentId to the global variable equipmentDetailId
                            equipmentDetailId = firstEquipmentId;
                            console.log('Fetching details for the Second equipment ID:', equipmentDetailId);

                            // Reset font-weight for all before highlighting the first one
                            $('.equipment-id').css('font-weight', 'normal');  // Reset all to normal

                            // Highlight the first equipment by default
                            $(`.equipment-id[data-equip-id='${firstEquipmentId}']`).css('font-weight', 'bold');  // Highlight default

                            fetchEquipmentDetails(equipmentDetailId);  // Automatically fetch details for the first ID

                        } else {
                            console.log('No equipment detail IDs found for this jobId.');
                            $('#equipmentContainer').html('No equipment found');  // Handle empty case
                        }
                    },
                    error: function (error) {
                        console.error('Error fetching equipment detail IDs:', error);
                    }
                });
            }
            // to end changes here

            // Create a reusable function to fetch equipment details based on equipment ID
            function fetchEquipmentDetails(equipmentDetailId) {
                $.ajax({
                    url: '/fetch-equipment-details-multiple/', // Django view URL
                    type: 'GET',
                    data: {equipId: equipmentDetailId}, // Use the equipmentDetailId to fetch details
                    success: function (response) {
                        if (response.status === 'success') {
                            var data = response.data; // This is now an array of objects
                            console.log('Fetched DATA:', data); // Debug: Check fetched data

                            // Call the function to show existing values
                            showExistingValues(data, equipmentDetailId);

                            // Make the right equipment container visible
                            $('#rightEquipment').css('display', 'block');  // Change the display property to block
                        } else {
                            alert(response.message); // Show error message if no data found
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Error fetching equipment details: ' + error);
                    }
                });
            }

            // show existing values based on that tempId from the temp_equipment_details table
            function showExistingValues(data, equipmentDetailId) {
                console.log('Fetch the show exising:', data, equipmentDetailId)
                var newSection = `
                    <div class="equipment-section" data-temp-id="${equipmentDetailId}">
                        <div class="row">
                            <div class="col-xl-3 mb-4">
                                <label for="locationName" class="form-label">Location</label>
                                <input type="text" class="form-control" id="locationNameExisting" name="location_name" value="${data[0].location}">
                            </div>
                            <div class="col-xl-3 mb-4">
                                <label for="inchargeEmployee" class="form-label">Incharge</label>
                                <input type="text" class="form-control dropdown-toggle"
                                       id="inchargeEmployeeExisting" data-bs-toggle="dropdown"
                                       aria-expanded="false" placeholder="Select Incharge Name"
                                       autocomplete="off" name="employee_name" value="${data[0].incharge}">
                                <ul class="employee-dropdown-menu" aria-labelledby="inchargeEmployee" id="employee-dropdown-item">
                                    <!-- Dynamic options will be appended here -->
                                </ul>
                            </div>
                            <div class="col-xl-3 mb-4">
                                <label for="setupDate" class="form-label">Rehearsal Date</label>
                                <input type="date" class="form-control" id="setupDateExisting" name="setup_date" value="${data[0].setup_date}" required>
                            </div>
                            <div class="col-xl-3 mb-4">
                                <label for="rehearsalDate" class="form-label">Event Date</label>
                                <input type="date" class="form-control" id="rehearsalDateExisting" name="rehearsal_date" value="${data[0].rehearsal_date}" required>
                            </div>
                        </div>
                        <div class="equipment-table-container">
                            <button class="btn btn-primary add-equipment-btn btn-sm" id="insertUpdatedForm"><i class="fa-solid fa-plus"></i></button>
                            <table id="selectedEquipmentTable" class="table custom-table">
                                <thead class="thead-dark">
                                    <tr>
                                        <th style="text-align: left;">Equipment Name</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                        <th>Notes</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(detail => `
                                    <tr data-equip-id="${detail.id}">
                                        <td><input type="hidden" name="equipment_id" value="${detail.id}" /><input type="text" name="equipment_name" value="${detail.equipment_name}" /></td>
                                        <td><input type="number" name="quantity" class="quantity-input" id="quantityTotalAmount" value="${detail.quantity}" /></td>
                                        <td><input type="number" name="unit_price" class="unit-price-input" value="${detail.unit_price}" readonly /></td>
                                        <td><input type="text" name="total" class="total-input" id="totalEquipmetAmount" value="${detail.total}" readonly /></td>
                                        <td><input type="text" name="equipment_notes_temp" value="${detail.equipment_notes}" /></td>
                                        <td><button class="btn btn-secondary delete-equipment-btn"><i class="fa fa-times"></i></button></td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                $('#rightEquipment').html(newSection);

                // Attach the event listener for quantity input changes
                $('.quantity-input').on('input', function () {
                    console.log('Quantity input changed, calling calculateTotalAmount');
                    calculateTotalAmount(jobId); // Call with the job ID
                });
            }

            // Update row
            // Input event handler with a check for equipmentDetailId
            $(document).on('input', 'input[name="quantity"], input[name="unit_price"], input[name="equipment_notes_temp"], #locationNameExisting, #inchargeEmployeeExisting, #setupDateExisting, #rehearsalDateExisting', function () {
                // Check if equipmentDetailId is set
                if (typeof equipmentDetailId === 'undefined') {
                    console.warn('Equipment Detail ID is not set yet. Make sure to click an equipment ID first.');
                    return; // Exit the function if ID is not set
                 }

                var row = $(this).closest('tr'); // Get the current row

                // Use the global variable for elementEquipId
                var elementEquipId = equipmentDetailId;
                console.log('Check the global element id:', elementEquipId);

                // Fetch updated values from input fields
                var quantity = parseFloat(row.find('input[name="quantity"]').val()) || 0; // Default to 0 if NaN
                var unitPrice = parseFloat(row.find('input[name="unit_price"]').val()) || 0; // Default to 0 if NaN
                var equipmentNotes = row.find('input[name="equipment_notes_temp"]').val(); // Fetch equipment notes
                var total = (quantity * unitPrice).toFixed(2); // Calculate total and fix to 2 decimal points
                row.find('input[name="total"]').val(total); // Update the total field
                console.log('check the equipment Notes:', equipmentNotes)

                // Fetch location and incharge from the inputs
                var location = $('#locationNameExisting').val();  // Location input
                var incharge = $('#inchargeEmployeeExisting').val();  // Incharge input
                var setupDate = $('#setupDateExisting').val(); // Setup date input
                var rehearsalDate = $('#rehearsalDateExisting').val(); // Rehearsal date input

                // Send an AJAX request to update both equipment details and location, incharge
                $.ajax({
                    url: '/update-equipment-id/', // The Django view URL for updating
                    type: 'POST',
                    data: {
                        rowEquipId: row.find('input[name="equipment_id"]').val(), // Get equipment ID from row
                        elementEquipId: elementEquipId, // Send equipment ID from global variable
                        equipment_name: row.find('input[name="equipment_name"]').val(),  // Equipment details
                        quantity: quantity,
                        unit_price: unitPrice,
                        total: total,
                        equipment_notes_temp: equipmentNotes, // Add equipment notes to the data
                        location: location,             // Location (from element)
                        incharge: incharge,             // Incharge (from element)
                        setup_date: setupDate,          // Setup date
                        rehearsal_date: rehearsalDate,  // Rehearsal date
                        csrfmiddlewaretoken: '{{ csrf_token }}' // CSRF token for security
                    },
                    success: function (response) {
                        console.log('Update Response:', response); // Log full response
                        if (response.status === 'success') {
                            console.log('Equipment updated successfully.');
                            // Optionally, you could update the UI here based on response
                        } else {
                            alert('Failed to update equipment: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Error updating equipment: ' + error);
                    }
                });
            });

            $(document).on('click', '.equipment-plus-sign, #createNewForm', function () {
                addNewEquipmentSection();
            });

            // create new form after click on equipment plus sign
            function addNewEquipmentSection() {
                var newSection = `
        <div class="equipment-section" data-temp-id="${jobId}">
            <div class="row">
                <div class="col-xl-3 mb-4">
                    <label for="locationName" class="form-label">Location</label>
                    <input type="text" class="form-control" id="locationName" name="location_name">
                </div>
                <div class="col-xl-3 mb-4">
                    <label for="inchargeEmployee" class="form-label">Incharge</label>
                    <input type="text" class="form-control dropdown-toggle"
                                   id="inchargeEmployee"
                                   data-bs-toggle="dropdown" aria-expanded="false"
                                   placeholder="Select Incharge Name" autocomplete="off"
                                   name="employee_name">
                    <ul class="employee-dropdown-menu" aria-labelledby="inchargeEmployee" id="employee-dropdown-item">
                        <!-- Dynamic options will be appended here -->
                    </ul>
                </div>
                <div class="col-xl-3 mb-4">
                    <label for="setupDate" class="form-label">Rehearsal Date</label>
                    <input type="date" class="form-control" id="setupDate" name="setup_date" required>
                </div>
                <div class="col-xl-3 mb-4">
                    <label for="rehearsalDate" class="form-label">Event Date</label>
                    <input type="date" class="form-control" id="rehearsalDate" name="rehearsal_date" required>
                </div>
            </div>
            <div class="equipment-table-container">
                <button class="btn btn-primary add-equipment-btn btn-sm" id="addNewEquipmentForm"><i class="fa-solid fa-plus"></i></button>
                <button class="btn btn-success insert-details-btn btn-sm" id="insertDetailsBtn"><i class="fa fa-save"></i></button>
                <table id="selectedEquipmentTable" class="table custom-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Equipment Name</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" id="equipmentNameClick" name="equipment_name" /></td>
                            <td><input type="number" name="quantity" class="quantity-input" /></td>
                            <td><input type="number" name="unit_price" class="unit-price-input" readonly /></td>
                            <td><input type="text" name="total" class="total-input" readonly /></td>
                            <td><input type="text" name="equipment_notes" class="equipment-notes" /></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;

                $('#rightEquipment').html(newSection); // Replace previous content with new content

                // Disable further clicks on #addNewEquipment
                $('#addNewEquipment').off('click');
            }

            $('#rightEquipment').on('click', 'input[name="equipment_name"]', function () {
                fetchEquipmentData();
            });

            // Use event delegation to bind input event for dynamically added inchargeEmployee
            $(document).on('input', '#inchargeEmployee, #inchargeEmployeeExisting', function () {
                const query = $(this).val();
                const inputId = $(this).attr('id'); // Get the ID of the input field

                if (query.length > 0) {
                    $.ajax({
                        url: '/fetch-employee-names/',
                        type: 'GET',
                        data: {query: query},
                        success: function (data) {
                            $('#employee-dropdown-item').empty(); // Clear previous results

                            data.forEach(employee => {
                                $('#employee-dropdown-item').append(
                                    `<li class="dropdown-item" data-id="${employee.id}">${employee.name}</li>`
                                );
                            });

                            // Add click event to the newly created list items
                            $('.dropdown-item').on('click', function () {
                                const selectedName = $(this).text();

                                // Set the value of the respective input field based on where the dropdown was triggered
                                if (inputId === 'inchargeEmployee') {
                                    $('#inchargeEmployee').val(selectedName);
                                    $('#employee-dropdown-item').empty(); // Clear dropdown
                                } else if (inputId === 'inchargeEmployeeExisting') {
                                    $('#inchargeEmployeeExisting').val(selectedName);
                                    $('#employee-dropdown-item').empty(); // Clear dropdown
                                }

                            });
                        },
                        error: function (xhr, status, error) {
                            console.error('Error fetching employee names:', error);
                        }
                    });
                } else {
                    $('#employee-dropdown-item').empty(); // Clear dropdown if input is empty
                }
            });

            // Function to open the popup
            function openPopup() {
                document.getElementById("equipmentPopup").style.display = "block";
            }

            // Function to fetch equipment data
            function fetchEquipmentData() {
                $.ajax({
                    url: '/fetch-equipment-data/',  // URL for the Django view that fetches equipment data
                    type: 'GET',
                    success: function (response) {
                        console.log('AJAX Response:', response);
                        if (response.data) {
                            var tableBody = $('#equipmentTable tbody');
                            tableBody.empty(); // Clear existing rows
                            $.each(response.data, function (index, equipment) {
                                tableBody.append(
                                    '<tr>' +
                                    '<td><input type="number" name="quantity_' + equipment.id + '" placeholder="Enter quantity" style="width: 100%;"></td>' +
                                    '<td>' + equipment.equipment_name + '</td>' +
                                    '<td>' + equipment.available_quantity + '</td>' +
                                    '<td>' + equipment.rental_price + '</td>' +
                                    '</tr>'
                                );
                            });
                            openPopup(); // Open the popup after data is fetched
                        } else {
                            console.log('No data received');
                        }
                    },
                    error: function (error) {
                        console.log('Error in AJAX request:', error);
                    }
                });
            }

            document.getElementById('saveEquipmentList').addEventListener('click', function (event) {
                // Prevent the default behavior (page refresh)
                event.preventDefault();

                // You can also close the popup here or do any other necessary actions
                document.getElementById('equipmentPopup').style.display = 'none';
            });

            // Event listener for the "Save" button
            $('#saveEquipmentList').click(function () {
                var selectedEquipmentBody = $('#selectedEquipmentTable tbody');

                // Remove only blank rows from the selected equipment table
                selectedEquipmentBody.find('tr').each(function () {
                    var quantityInput = $(this).find('input[name="quantity"]');
                    if (quantityInput.val() === "" || quantityInput.val() <= 0) {
                        $(this).remove(); // Remove the row if quantity is empty or zero
                    }
                });

                // Loop through each row in the equipment table
                $('#equipmentTable tbody tr').each(function () {
                    var quantityInput = $(this).find('input[name^="quantity_"]');
                    var equipmentName = $(this).find('td:eq(1)').text(); // Get equipment name from the second column
                    var availableQuantity = $(this).find('td:eq(2)').text(); // Get available quantity
                    var unitPrice = $(this).find('td:eq(3)').text(); // Get rental price

                    var quantity = quantityInput.val();
                    if (quantity > 0) { // Only include items where quantity is entered
                        // Check if the quantity is greater than the available quantity
                        if (parseInt(quantity) > parseInt(availableQuantity)) {
                            alert('Quantity for ' + equipmentName + ' exceeds available quantity. Skipping this row.');
                            return true; // Skip this row and continue to the next one
                        }

                        // Check if the equipment name is already in the selected equipment table
                        var existingRow = selectedEquipmentBody.find('tr:contains("' + equipmentName + '")');
                        if (existingRow.length === 0) { // If it does not exist
                            var total = (unitPrice.replace('?', '') * quantity).toFixed(2); // Calculate total

                            // Append the new row to the selected equipment table
                            selectedEquipmentBody.append(
                                '<tr>' +
                                '<td>' + equipmentName + '</td>' +
                                '<td>' + quantity + '</td>' +
                                '<td>' + unitPrice + '</td>' +
                                '<td>' + total + '</td>' +
                                '<td><input type="text" style="width: 100%;" name="equipment_notes" placeholder="Enter value"></td>' +
                                '</tr>'
                            );
                        }
                        // If the item already exists, do nothing (skip adding)
                    }
                });

                // Optionally close the popup after saving the equipment list
                closePopup();
            });

            $(document).on('click', '#insertDetailsBtn', function (event) {
                event.preventDefault();
                var equipmentData = [];
                var tempId = jobId; // Get tempId from window object

                // Fetch the new input values
                var locationName = $('#locationName').val();
                var inchargeName = $('#inchargeEmployee').val();
                var setupDate = $('#setupDate').val();
                var rehearsalDate = $('#rehearsalDate').val();

                $('#selectedEquipmentTable tbody tr').each(function () {
                    var equipmentDetail = {
                        equipment_name: $(this).find('td:eq(0)').text(), // Equipment Name
                        quantity: $(this).find('td:eq(1)').text(), // Quantity
                        equipment_unit_price: $(this).find('td:eq(2)').text(), // Unit Price
                        equipment_total: $(this).find('td:eq(3)').text(), // Total
                        equipment_notes: $(this).find('input[name="equipment_notes"]').val(), // Capture the notes value
                        location: locationName, // Add location
                        incharge: inchargeName, // Add incharge
                        equipment_setup_date: setupDate, // Add setup date
                        equipment_rehearsal_date: rehearsalDate // Add rehearsal date
                    };
                    equipmentData.push(equipmentDetail);
                });

                $.ajax({
                    url: '/insert-equipment-details/', // Updated URL
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({equipment: equipmentData, temp_id: tempId}),
                    success: function (response) {
                        alert(response.message); // Show success message

                        // Display the equipment_detail_ids in the specified HTML elements
                        // Get unique equipment_detail_ids from the response
                        const uniqueEquipmentIds = [...new Set(response.equipment_detail_ids)];
                        console.log('Fetch the Unique Equipment:', uniqueEquipmentIds)
                        const equipmentContainer = $('#equipmentContainer'); // Assuming you have a container to hold these spans
                        console.log('Fetch the DETAILS:', equipmentContainer)

                        // Clear the container before adding new spans
                        equipmentContainer.empty();

                        uniqueEquipmentIds.forEach(function (equipId) {
                            // Create a new span with the "+" sign and equipment ID in the desired format
                            const newSpan = $('<div><span class="toggle-sign" id="createNewEquipment">+</span> <span id="equipmentIdName" class="equipment-name" data-equip-id="' + equipId + '" style="cursor: pointer;">' + equipId + '</span></div>');
                            console.log('Fetch the equip ID:', equipId)
                            equipmentContainer.append(newSpan);
                            console.log('Fetch the span id of:', equipmentContainer)
                        });
                        $.ajax({
                            url: '/fetch-equipment-details-multiple/', // Django view URL
                            type: 'GET',
                            data: {equipId: equipmentDetailId}, // Use the equipmentDetailId to fetch details
                            success: function (response) {
                                if (response.status === 'success') {
                                    var data = response.data; // This is now an array of objects
                                    console.log('Fetched DATA:', data); // Debug: Check fetched data

                                    // Call the function to show existing values
                                    showExistingValues(data, equipmentDetailId);

                                    // Make the right equipment container visible
                                    $('#rightEquipment').css('display', 'block');  // Change the display property to block
                                } else {
                                    alert(response.message); // Show error message if no data found
                                }
                            },
                            error: function (xhr, status, error) {
                                alert('Error fetching equipment details: ' + error);
                            }
                        });
                    },
                    error: function (xhr, status, error) {
                        alert('Error inserting equipment details: ' + error);
                    }
                });
            });

            $(document).on('click', '#insertUpdatedForm', function (event) {
                event.preventDefault(); // Prevent any default actions

                // Create a new row
                const newRow = `
                    <tr>
                        <td><input type="text" id="equipmentNameClick" name="equipment_name_insert"/></td>
                        <td><input type="number" name="quantity" class="quantity-input"/></td>
                        <td><input type="number" name="unit_price" class="unit-price-input" readonly /></td>
                        <td><input type="text" name="total" class="total-input" readonly /></td>
                    </tr>
                `;

                // Append the new row to the table body
                $('#selectedEquipmentTable tbody').append(newRow);
            });

            $('#rightEquipment').on('click', 'input[name="equipment_name_insert"]', function () {
                fetchEquipmentInsertData();
            });

            function fetchEquipmentInsertData() {
                $.ajax({
                    url: '/fetch-equipment-data/',  // URL for the Django view that fetches equipment data
                    type: 'GET',
                    success: function (response) {
                        console.log('AJAX Response:', response);
                        if (response.data) {
                            var tableBody = $('#equipmentTable tbody');
                            tableBody.empty(); // Clear existing rows
                            $.each(response.data, function (index, equipment) {
                                tableBody.append(
                                    '<tr>' +
                                    '<td><input type="number" name="quantity_' + equipment.id + '" placeholder="Enter quantity" style="width: 100%;"></td>' +
                                    '<td>' + equipment.equipment_name + '</td>' +
                                    '<td>' + equipment.available_quantity + '</td>' +
                                    '<td>' + equipment.rental_price + '</td>' +
                                    '</tr>'
                                );
                            });
                            openInsertPopup(); // Open the popup after data is fetched
                        } else {
                            console.log('No data received');
                        }
                    },
                    error: function (error) {
                        console.log('Error in AJAX request:', error);
                    }
                });
            }

            $('#existingSaveEquipmentList').click(function (event) {
                console.log('Check the 1st step working...')
                event.preventDefault(); // Prevent the default form submission
                console.log('Check the 1st step working...')

                var selectedEquipmentBody = $('#selectedEquipmentTable tbody');
                var tempId = jobId; // Replace with the actual temp_id
                var equipDetailId = equipmentDetailId; // Replace with the actual equipment_detail_id
                var location = $('#locationNameExisting').val(); // Replace with the actual location
                var incharge = $('#inchargeEmployeeExisting').val(); // Replace with the actual incharge
                var setupDate = $('#setupDateExisting').val(); // Replace with the actual setup date
                var rehearsalDate = $('#rehearsalDateExisting').val(); // Replace with the actual rehearsal date
                console.log('Check the 2st step working...')
                console.log('Check the 1st step working...', selectedEquipmentBody, tempId, equipDetailId, location, incharge, setupDate, rehearsalDate)

                // Remove only blank rows from the selected equipment table
                selectedEquipmentBody.find('tr').each(function () {
                    var quantityInput = $(this).find('input[name="quantity"]');
                    if (quantityInput.val() === "" || quantityInput.val() <= 0) {
                        $(this).remove(); // Remove the row if quantity is empty or zero
                    }
                });
                console.log('Check the 3rd step working...', selectedEquipmentBody)

                // Prepare an array to hold the data to be sent to the backend
                var equipmentData = [];
                console.log('Check the 4th step working...')

                // Loop through each row in the equipment table
                $('#equipmentTable tbody tr').each(function () {
                    var quantityInput = $(this).find('input[name^="quantity_"]');
                    var equipmentName = $(this).find('td:eq(1)').text(); // Get equipment name from the input field
                    var availableQuantity = $(this).find('td:eq(2)').text(); // Get available quantity
                    var unitPrice = $(this).find('td:eq(3)').text(); // Get rental price

                    var quantity = quantityInput.val();
                    if (quantity > 0) { // Only include items where quantity is entered
                        // Check if quantity entered is less than or equal to available quantity
                        if (parseInt(quantity) > parseInt(availableQuantity)) {
                            alert('Quantity for ' + equipmentName + ' exceeds available quantity. Available Quantity is:' + availableQuantity + '');
                            return true; // Skip this iteration (continue to the next row)
                        }

                        var total = (unitPrice.replace('?', '') * quantity).toFixed(2); // Calculate total

                        // Prepare the data object for this row
                        equipmentData.push({
                            temp_id: tempId,
                            equipment_detail_id: equipDetailId,
                            location: location,
                            incharge: incharge,
                            setup_date: setupDate,
                            rehearsal_date: rehearsalDate,
                            equipment_name: equipmentName,
                            quantity: quantity,
                            equipment_unit_price: unitPrice,
                            equipment_total: total
                        });
                    }
                });
                console.log('Check the 5th step working...')

                // AJAX request to insert the data into the temp_equipment_details table
                $.ajax({
                    url: '/insert-equipment-details-id/', // Update with your backend endpoint
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(equipmentData),
                    success: function (response) {
                        console.log("Data inserted successfully:", response);

                        // Automatically hide the equipment popup after successful insertion
                        $('#equipmentInsertPopup').hide(); // Hide the popup

                        // Automatically call the second AJAX to fetch equipment details after successful insertion
                        $.ajax({
                            url: '/fetch-equipment-details-multiple/', // Django view URL
                            type: 'GET',
                            data: {equipId: equipmentDetailId}, // Use the equipmentDetailId to fetch details
                            success: function (response) {
                                if (response.status === 'success') {
                                    var data = response.data; // This is now an array of objects
                                    console.log('Fetch the DATA:', data); // Debug: Check fetched data

                                    // Call the function to show existing values
                                    showExistingValues(data);
                                } else {
                                    alert(response.message); // Show error message if no data found
                                }
                            },
                            error: function (xhr, status, error) {
                                alert('Error fetching equipment details: ' + error);
                            }
                        });

                        // Optionally close the popup after saving the equipment list
                        closePopup();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error inserting data:", error);
                        // Optionally show an error message to the user
                    }
                });
            });

            // Function to open the popup
            function openInsertPopup() {
                document.getElementById("equipmentInsertPopup").style.display = "block";
            }

            $('#cancelInsertButton').click(function (e) {
                e.preventDefault();
                // Hide the popup
                $('#equipmentInsertPopup').hide();
            });

            // Delete the row functionality
            $(document).on('click', '.delete-equipment-btn', function (e) {
                e.preventDefault();

                // Find the equipment ID from the hidden input field
                var row = $(this).closest('tr'); // Get the row where the delete button was clicked
                var equipmentId = row.find('input[name="equipment_id"]').val(); // Fetch the equipment_id from hidden input

                // Confirm deletion
                if (confirm('Are you sure you want to delete this equipment?')) {
                    // Make an AJAX request to delete the equipment
                    $.ajax({
                        url: '/delete-equipment-id/', // Your Django view for handling the delete request
                        type: 'POST',
                        data: {
                            equipId: equipmentId, // Send equipment ID to backend
                            csrfmiddlewaretoken: '{{ csrf_token }}' // CSRF token for security
                        },
                        success: function (response) {
                            if (response.status === 'success') {
                                // Remove the row from the table if deletion was successful
                                row.remove();
                                {#alert('Equipment deleted successfully.');#}
                            } else {
                                alert('Failed to delete equipment: ' + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            alert('Error deleting equipment: ' + error);
                        }
                    });
                }
            });

            // Filter table rows based on the search input
            $('#searchBar').on('keyup', function () {
                var searchTerm = $(this).val().toLowerCase(); // Get the search term and convert to lowercase

                // Iterate over each row in the equipment table
                $('#equipmentTable tbody tr').each(function () {
                    var row = $(this);
                    var equipmentName = row.find('td:eq(1)').text().toLowerCase(); // Get the equipment name (second column)

                    // Check if the equipment name includes the search term
                    if (equipmentName.includes(searchTerm)) {
                        row.show();  // Show the row if it matches the search
                    } else {
                        row.hide();  // Hide the row if it doesn't match
                    }
                });
            });

            // Event listener for the search bar input
            $('#searchBarExisting').on('keyup', function () {
                var searchTerm = $(this).val().toLowerCase(); // Get the search term and convert to lowercase

                // Iterate over each row in the equipment table
                $('#equipmentTable tbody tr').each(function () {
                    var row = $(this);
                    var equipmentName = row.find('td:eq(1)').text().toLowerCase(); // Get the equipment name from the second column

                    // Check if the equipment name contains the search term
                    if (equipmentName.includes(searchTerm)) {
                        row.show();  // Show the row if it matches the search term
                    } else {
                        row.hide();  // Hide the row if it doesn't match
                    }
                });
            });

            $('#cancelButton').click(function (e) {
                e.preventDefault();
                // Hide the popup
                $('#equipmentPopup').hide();
            });

            $('#cancelSaveEquipmentButton').click(function (e) {
                e.preventDefault();

                $('#equipmentInsertPopup').hide();
            });

            $(document).on('click', '#addNewEquipmentForm', function (event) {
                event.preventDefault(); // Prevent any default actions

                // Create a new row
                const newRow = `
                    <tr>
                        <td><input type="text" id="equipmentNameClick" name="equipment_name"/></td>
                        <td><input type="number" name="quantity" class="quantity-input"/></td>
                        <td><input type="number" name="unit_price" class="unit-price-input" readonly /></td>
                        <td><input type="text" name="total" class="total-input" readonly /></td>
                    </tr>
                `;

                // Append the new row to the table body
                $('#selectedEquipmentTable tbody').append(newRow);
            });

            // Sub Vendor Section
            // Function to add a new row when the button is clicked
            $('#add-sub-vendor-row-btn').click(function (event) {
                event.preventDefault();
                // Create the new row HTML
                var newRow = `
                    <tr>
                        <td>
                            <input type="text" name="vendor-name" placeholder="Vendor Name" class="form-control">
                        </td>
                        <td>
                            <input type="text" name="equipment-name" placeholder="Equipment Name" class="form-control">
                        </td>
                        <td>
                            <input type="number" name="quantity" placeholder="Quantity" class="form-control">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary save-sub-vendor-row me-2" data-toggle="tooltip" title="Save Sub Vendor Row" id="insertSubVendor" style="background-color: #0d99ff;">
                                <i class="fa fa-check"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-danger remove-sub-vendor-row me-2" data-toggle="tooltip" title="Delete Sub Vendor Row" style="background-color: #ff5e5e;">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;

                // Append the new row to the table body
                $('#sub-vendor-table tbody').append(newRow);
            });

            // AJAX call to fetch the sub-vendor details
            $.ajax({
                url: '/fetch-sub-vendor-details/' + jobId + '/',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var tableBody = $('#sub-vendor-table tbody');
                    tableBody.empty(); // Clear the table body

                    // Loop through the data and append rows to the table in the desired format
                    data.forEach(function (item) {
                        var newRow = `
                            <tr data-id="${item.id}"> <!-- Store the ID in a data attribute -->
                                <td>
                                    <input type="text" name="vendor-name" value="${item.vendor_name}" placeholder="Vendor Name" class="form-control">
                                </td>
                                <td>
                                    <input type="text" name="equipment-name" value="${item.sub_equipment_name}" placeholder="Equipment Name" class="form-control">
                                </td>
                                <td>
                                    <input type="number" name="quantity" value="${item.sub_quantity}" placeholder="Quantity" class="form-control">
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary update-sub-vendor-row me-2" data-toggle="tooltip" title="Update Sub Vendor Row" id="insertSubVendor" style="background-color: #0d99ff;">
                                        <i class="fa fa-check"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger delete-sub-vendor-row me-2" data-toggle="tooltip" title="Delete Sub Vendor Row" style="background-color: #ff5e5e;">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        tableBody.append(newRow);
                    });
                },
                error: function (error) {
                    console.log('Error fetching sub-vendor details:', error);
                }
            });

            // Example function to handle saving changes
            $(document).on('click', '.update-sub-vendor-row', function () {
                var row = $(this).closest('tr');
                var id = row.data('id'); // Retrieve the ID from the data attribute
                var vendorName = row.find('input[name="vendor-name"]').val();
                var equipmentName = row.find('input[name="equipment-name"]').val();
                var quantity = row.find('input[name="quantity"]').val();

                // Perform the AJAX request to update the row
                $.ajax({
                    url: '/update-sub-vendor-details/', // Ensure this URL matches your Django URL pattern
                    type: 'POST',
                    data: JSON.stringify({
                        id: id,
                        vendor_name: vendorName,
                        equipment_name: equipmentName,
                        quantity: quantity
                    }),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.status === 'success') {
                            alert('Sub-vendor details updated successfully');
                        } else {
                            alert('Error updating sub-vendor details: ' + response.error);
                        }
                    },
                    error: function (error) {
                        alert('Error updating sub-vendor details');
                        console.log(error);
                    }
                });
            });

            $('#sub-vendor-table').on('click', '.save-sub-vendor-row', function (event) {
                event.preventDefault(); // Prevent the form submission

                const row = $(this).closest('tr');
                const subVendorDetails = {
                    temp_id: jobId,  // Ensure tempId is correctly defined
                    vendor_name: row.find('input[name="vendor-name"]').val(),
                    sub_equipment_name: row.find('input[name="equipment-name"]').val(),
                    sub_quantity: row.find('input[name="quantity"]').val(),
                };

                // Check the structure before sending
                console.log('Sending Data:', subVendorDetails);

                $.ajax({
                    url: '/insert-sub-vendor-details/',  // Ensure this URL is correct
                    type: 'POST',
                    data: JSON.stringify(subVendorDetails),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.status === 'success') {
                            alert('Sub-vendor details inserted successfully');
                        } else {
                            alert('Error inserting sub-vendor details: ' + response.error);
                        }
                    },
                    error: function (error) {
                        alert('Error inserting sub-vendor details');
                        console.log(error);
                    }
                });
            });

            $(document).on('click', '.delete-sub-vendor-row', function () {
                var $button = $(this);
                var row = $button.closest('tr'); // Get the closest <tr> element
                var id = row.data('id'); // Fetch the ID from the data attribute

                if (!id) {
                    alert('Invalid ID');
                    return;
                }

                // Confirm the deletion
                if (confirm('Are you sure you want to delete this sub-vendor row?')) {
                    // Send an AJAX request to delete the row
                    $.ajax({
                        url: '/delete-sub-vendor/' + id + '/',
                        type: 'DELETE',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}' // Include CSRF token if CSRF protection is enabled
                        },
                        success: function (response) {
                            if (response.success) {
                                row.remove(); // Remove the row from the table
                                alert('Sub-vendor row deleted successfully.');
                            } else {
                                alert('Failed to delete sub-vendor row.');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error deleting sub-vendor row:', error);
                            alert('Error occurred while deleting sub-vendor row.');
                        }
                    });
                }
            });

            // Crew Allocation Section Start
            // Function to fetch and display crew details in the table
            function fetchCrewDetails(jobId) {
                console.log('Check the crew job ID:', jobId)
                $.ajax({
                    url: '/fetch-temp-crew-details/',
                    type: 'GET',
                    data: {tempId: jobId},  // Pass the temp_id to fetch the data
                    success: function (response) {
                        if (response.status === 'success') {
                            var data = response.data;
                            console.log('check the response DATA:', data)

                            // Clear the existing rows in the table body
                            $('#crew-allocation-table-body').empty();

                            // Loop through the data and append rows to the table body
                            data.forEach(function (item) {
                                const newRow = `
                        <tr class="editable-row" data-category-id="${item.id}">
                            <td style="width: 40px;">
                                <button class="btn btn-sm btn-primary edit-crew-list-btn me-2" data-toggle="tooltip" title="Edit"><i class="fa fa-pencil"></i></button>
                                <button class="btn btn-sm btn-success edit-save-btn me-2" style="display:none;" data-toggle="tooltip" title="Save" id="save-crew-allocation"><i class="fa fa-save"></i></button>
                                <button class="btn btn-sm btn-secondary edit-cancel-btn me-2" style="display:none;" data-toggle="tooltip" title="Cancel" id="cancel-crew-allocation"><i class="fa fa-times"></i></button>
                                <button class="btn btn-sm btn-danger delete-crew-btn me-2" data-toggle="tooltip" title="Delete"><i class="fa fa-trash"></i></button>

                                <!-- Hidden input to store the ID for update/delete -->

                            </td>
                            <td style="font-size: 14px;">${item.crew_type}</td>
                            <td style="font-size: 14px;">${item.crew_no_of_days}</td>
                            <td style="font-size: 14px;">${item.perday_charges}</td>
                            <td style="font-size: 14px;">${item.total}</td>
                            <td style="font-size: 14px;">${item.crew_notes}</td>
                        </tr>`;

                                // Append the new row to the table body
                                $('#crew-allocation-table-body').append(newRow);
                            });
                        } else {
                            alert(response.message);  // Show error message if something goes wrong
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Error fetching crew details: ' + error);
                    }
                });
            }

            // Example of calling the function with a tempId
            fetchCrewDetails(jobId);  // Pass the tempId as required

            function activateEditMode(row) {
                // Hide the Edit button and show Save/Cancel buttons
                row.find('.edit-btn, .delete-btn').hide();
                row.find('.save-btn, .cancel-btn').show();

                // Attach event handler to the Cancel button
                row.find('.cancel-crew-btn').on('click', function () {
                    row.remove(); // Remove the row from the UI
                });
            }

            function cancelEditMode(row) {
                row.find('td').each(function (index, element) {
                    const cell = $(element);

                    if (cell.data('editable') === true) {
                        const input = cell.find('input');
                        if (input.length) {
                            const value = input.val();
                            cell.text(value);
                        }
                    } else if (cell.data('editable-select') === true) {
                        const select = cell.find('select');
                        if (select.length) {
                            const value = select.val();
                            cell.text(value === '1' ? 'Active' : 'Inactive');
                        }
                    }
                });// Show the Edit button and hide Save/Cancel buttons
                row.find('.edit-btn, .delete-btn').show();
                row.find('.save-btn, .cancel-btn').hide();
            }

            // Adding new row for Master Category
            $(document).on('click', '#addCrewAllocationRow', function () {
                const newRow = `
        <tr class="editable-row">
            <td>
                <button class="btn btn-success save-crew-btn"><i class="fa fa-save"></i></button>
                <button class="btn btn-secondary cancel-crew-btn"><i class="fa fa-times"></i></button>
                <button class="btn btn-primary edit-crew-btn" style="display:none;"><i class="fa fa-pencil"></i></button>
                <button class="btn btn-danger delete-crew-btn" style="display:none;"><i class="fa fa-trash"></i></button>
            </td>
            <td data-editable-select="true">
                <select class="default-select form-control" id="crewType" name="crew_type">
                    <option value="A1" selected>A1</option>
                    <option value="A2">A2</option>
                    <option value="A3">A3</option>
                </select>
            </td>
            <td data-editable="true"><input type="text" class="form-control" name="no_of_days" style="width: 83px;"></td>
            <td data-editable="true"><input type="text" class="form-control" name="perday_charges"></td>
            <td data-editable="true"><input type="text" class="form-control" name="total"></td>
            <td data-editable="true"><input type="text" class="form-control" name="crew_notes"></td>
        </tr>
    `;

                const $newRow = $(newRow); // Wrap the string with jQuery to create a jQuery object
                $('#crew-allocation-table-body').prepend($newRow); // Append the new row to the table

                activateEditMode($newRow); // Activate edit mode for the new row

                // Set 'A1' as the default selected value when the row is added
                $newRow.find('select').val('A1');
            });

            $(document).on('input', 'input[name="no_of_days"], input[name="perday_charges"]', function () {
                const $row = $(this).closest('tr'); // Get the current row
                const noOfDays = parseFloat($row.find('input[name="no_of_days"]').val()) || 0;
                const perDayCharges = parseFloat($row.find('input[name="perday_charges"]').val()) || 0;

                const total = noOfDays * perDayCharges;

                $row.find('input[name="total"]').val(total);
            });

            $(document).on('click', '.save-crew-btn', function (event) {
                event.preventDefault();

                const $row = $(this).closest('tr');

                // Get the values from the row inputs
                const crewType = $row.find('select[name="crew_type"]').val();
                const noOfDays = $row.find('input[name="no_of_days"]').val();
                const perDayCharges = $row.find('input[name="perday_charges"]').val();
                const total = $row.find('input[name="total"]').val();
                const crewNotes = $row.find('input[name="crew_notes"]').val();

                const tempId = jobId;

                // AJAX call to save the row data to the server
                $.ajax({
                    url: '/save_crew_allocation/',
                    method: 'POST',
                    data: {
                        'temp_id': tempId,
                        'crew_type': crewType,
                        'crew_no_of_days': noOfDays,
                        'perday_charges': perDayCharges,
                        'total': total,
                        'crew_notes': crewNotes,
                        'csrfmiddlewaretoken': getCsrfToken() // Use the function here
                    },
                    success: function (response) {
                        if (response.status === 'success') {
                            alert('Crew allocation saved successfully');

                            // Create a new row in the desired format
                            const newRow = `
                    <tr class="editable-row" data-category-id="${response.crew_allocation_id}">
                        <td style="width: 40px;">
                            <button class="btn btn-sm btn-primary edit-crew-list-btn me-2" data-toggle="tooltip" title="Edit"><i class="fa fa-pencil"></i></button>
                            <button class="btn btn-sm btn-success edit-save-btn me-2" style="display:none;" data-toggle="tooltip" title="Save" id="save-crew-allocation"><i class="fa fa-save"></i></button>
                            <button class="btn btn-sm btn-secondary edit-cancel-btn me-2" style="display:none;" data-toggle="tooltip" title="Cancel" id="cancel-crew-allocation"><i class="fa fa-times"></i></button>
                            <button class="btn btn-sm btn-danger delete-crew-btn me-2" data-toggle="tooltip" title="Delete"><i class="fa fa-trash"></i></button>
                        </td>
                        <td style="font-size: 14px;">${crewType}</td>
                        <td style="font-size: 14px;">${noOfDays}</td>
                        <td style="font-size: 14px;">${perDayCharges}</td>
                        <td style="font-size: 14px;" id="totalEquipmentAmount">${total}</td>
                        <td style="font-size: 14px;">${crewNotes}</td>
                    </tr>
                `;

                            // Replace the existing row with the new row HTML
                            $row.replaceWith(newRow);
                        } else {
                            alert('Failed to save crew allocation');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                        alert('An error occurred while saving the crew allocation. Please try again.'); // Provide user feedback
                    }
                });
            });

            $(document).on('click', '.delete-crew-btn', function (event) {
                event.preventDefault();
                const $row = $(this).closest('tr');
                const crewAllocationId = $row.data('category-id'); // Get the id from data attribute

                // Confirm deletion
                if (confirm('Are you sure you want to delete this crew allocation?')) {
                    // AJAX call to delete the crew allocation
                    $.ajax({
                        url: '/delete_crew_allocation_row/',
                        method: 'POST',
                        data: {
                            'crew_allocation_id': crewAllocationId,
                            'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val() // CSRF token
                        },
                        success: function (response) {
                            if (response.status === 'success') {
                                alert('Crew allocation deleted successfully');
                                $row.remove(); // Remove the row from the table
                            } else {
                                alert('Failed to delete crew allocation');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error:', error);
                            alert('An error occurred while deleting the crew allocation. Please try again.');
                        }
                    });
                }
            });

            $(document).on('click', '.edit-crew-list-btn', function (event) {
                event.preventDefault();
                const $row = $(this).closest('.editable-row');

                // Get current values
                const crewType = $row.find('td').eq(1).text();
                const noOfDays = $row.find('td').eq(2).text();
                const perDayCharges = $row.find('td').eq(3).text();
                const total = $row.find('td').eq(4).text();
                const crewNotes = $row.find('td').eq(5).text();

                // Replace text with input fields
                $row.find('td').eq(1).html(`
        <select class="default-select form-control" name="crew_type">
            <option value="A1" ${crewType === 'A1' ? 'selected' : ''}>A1</option>
            <option value="A2" ${crewType === 'A2' ? 'selected' : ''}>A2</option>
            <option value="A3" ${crewType === 'A3' ? 'selected' : ''}>A3</option>
        </select>
    `);

                $row.find('td').eq(2).html(`<input type="text" class="form-control" name="no_of_days" value="${noOfDays}" style="width: 83px;">`);
                $row.find('td').eq(3).html(`<input type="text" class="form-control" name="perday_charges" value="${perDayCharges}">`);
                $row.find('td').eq(4).html(`<input type="text" class="form-control" name="total" value="${total}">`);
                $row.find('td').eq(5).html(`<input type="text" class="form-control" name="crew_notes" value="${crewNotes}">`);

                // Toggle button visibility
                $row.find('.edit-crew-list-btn, .delete-crew-btn').hide();
                $row.find('.edit-save-btn, .edit-cancel-btn').show();
            });

            $(document).on('click', '#save-crew-allocation', function (event) {
                event.preventDefault();

                // Get the data-category-id from the row
                const $row = $(this).closest('.editable-row');
                const categoryId = $row.data('category-id');

                // Get values from input fields
                const crewType = $row.find('select[name="crew_type"]').val();
                const noOfDays = $row.find('input[name="no_of_days"]').val();
                const perDayCharges = $row.find('input[name="perday_charges"]').val();
                const total = $row.find('input[name="total"]').val();
                const crewNotes = $row.find('input[name="crew_notes"]').val();

                // Send AJAX request to update the database
                $.ajax({
                    type: 'POST',
                    url: '/update-crew-allocation-row/',
                    data: {
                        'id': categoryId,
                        'crew_type': crewType,
                        'no_of_days': noOfDays,
                        'perday_charges': perDayCharges,
                        'total': total,
                        'crew_notes': crewNotes,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        if (response.success) {
                            // Optionally, update the row text with new values
                            $row.find('td').eq(1).text(crewType);
                            $row.find('td').eq(2).text(noOfDays);
                            $row.find('td').eq(3).text(perDayCharges);
                            $row.find('td').eq(4).text(total);
                            $row.find('td').eq(5).text(crewNotes);

                            // Hide save and cancel buttons, show edit and delete buttons
                            $row.find('.edit-save-btn, .edit-cancel-btn').hide();
                            $row.find('.edit-crew-list-btn, .delete-crew-btn').show();
                        } else {
                            alert('Update failed: ' + response.error);
                        }
                    },
                    error: function () {
                        alert('An error occurred while updating the crew allocation.');
                    }
                });
            });

            function fetchCrewAllocation(jobId) {
                $.ajax({
                    url: '/fetch-crew-allocation-edit/', // Update this with your URL pattern
                    type: 'GET',
                    data: {jobId: jobId},
                    success: function (response) {
                        // Clear existing rows
                        $('#crew-allocation-delivery-table-body').empty();

                        // Loop through response data and create table rows
                        response.forEach(function (item) {
                            const newRow = `
                    <tr class="editable-row" data-crew-id="${item.crewId}">
                        <td style="width: 40px;">
                            <button class="btn btn-sm btn-primary edit-crew-delivery-btn me-2" data-toggle="tooltip" title="Edit Delivery Challen"><i class="fa fa-pencil"></i></button>
                            <button class="btn btn-sm btn-success edit-save-delivery-btn me-2" style="display:none;" data-toggle="tooltip" title="Save" id="save-crew-delivery-allocation"><i class="fa fa-save"></i></button>
                            <button class="btn btn-sm btn-secondary edit-cancel-btn me-2" style="display:none;" data-toggle="tooltip" title="Cancel" id="cancel-crew-allocation"><i class="fa fa-times"></i></button>
                            <button class="btn btn-sm btn-danger delete-crew-btn me-2" data-toggle="tooltip" title="Delete"><i class="fa fa-trash"></i></button>
                        </td>
                        <td style="font-size: 14px;">${item.crewType}</td>
                        <td style="font-size: 14px;">${item.employeeName}<input type="hidden" name="empId" value="${item.empId}"></td>
                        <td style="font-size: 14px;">${item.noOfDays}</td>
                        <td style="font-size: 14px;">${item.perDayCharges}</td>
                        <td style="font-size: 14px;">${item.total}</td>
                        <td style="font-size: 14px;">${item.crewNotes}</td>
                    </tr>
                `;
                            $('#crew-allocation-delivery-table-body').append(newRow);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching crew allocation data:", error);
                    }
                });
            }

            // Adding new row for status Delivery challen and Prepsheet
            $(document).on('input', '.employee-name', function () {
                console.log('check the employee name is working.');
                const query = $(this).val();
                console.log('Check the user Input:', query);
                const $currentRow = $(this).closest('tr'); // Store the current row
                $currentRow.find('#employeeId').val(''); // Clear the employeeId field
                $currentRow.find('.employee-delivery-dropdown').remove(); // Remove existing dropdown

                if (query.length > 0) {
                    console.log('check the search char');
                    $.ajax({
                        url: '/search-employee-crew/', // URL to Django view
                        data: {'query': query},
                        dataType: 'json',
                        success: function (data) {
                            console.log('check the Search DATA:', data);

                            // Create a Set to store unique employee names
                            const uniqueEmployees = new Set();

                            // Populate the Set with employee names
                            data.employees.forEach(emp => {
                                uniqueEmployees.add(emp.name);
                            });

                            // Create the dropdown element
                            let dropdown = $('<ul class="employee-delivery-dropdown" style="cursor: pointer;"></ul>');
                            console.log('check the fetch DATA:', dropdown);
                            $currentRow.find('.employee-name').after(dropdown); // Insert the dropdown after the input field
                            dropdown.empty(); // Clear previous results
                            console.log('check the dropdown empty is working.');

                            // Append unique employee names to the dropdown
                            uniqueEmployees.forEach(empName => {
                                dropdown.append(`<li class="employee-delivery-option">${empName}</li>`);
                            });

                            // Show the dropdown if there are results
                            if (uniqueEmployees.size > 0) {
                                console.log('check the dropdown of employee delivery option is work:');
                                dropdown.show(); // Ensure the dropdown is shown
                            }

                            // Show dropdown and bind click event
                            dropdown.on('click', '.employee-delivery-option', function () {
                                const employeeName = $(this).text();
                                console.log('check the employee name:', employeeName);
                                const employeeId = data.employees.find(emp => emp.name === employeeName).id; // Get the corresponding ID
                                console.log('check the id:', employeeId);

                                // Set selected employee in input field
                                $currentRow.find('.employee-name').val(employeeName);
                                $currentRow.find('#employeeId').val(employeeId); // Set employee ID in hidden input field

                                dropdown.remove(); // Remove dropdown after selection
                            });
                        },
                        error: function () {
                            console.error('Error fetching employees.');
                        }
                    });
                }
            });

            function activateDeliveryEditMode(row) {
                // Hide the Edit button and show Save/Cancel buttons
                row.find('.edit-delivery-btn, .delete-delivery-btn').hide();
                row.find('.save-delivery-btn, .cancel-delivery-btn').show();

                // Attach event handler to the Cancel button
                row.find('.cancel-delivery-btn').on('click', function () {
                    row.remove(); // Remove the row from the UI
                });
            }

            $(document).on('click', '#addCrewAllocationDeliveryRow', function () {
                const newRow = `
                    <tr class="editable-row-delivery">
                        <td>
                            <button class="btn btn-success save-crew-delivery-btn"><i class="fa fa-save"></i></button>
                            <button class="btn btn-secondary cancel-crew-delivery-btn"><i class="fa fa-times"></i></button>
                            <button class="btn btn-primary edit-crew-delivery-btn" style="display:none;"><i class="fa fa-pencil"></i></button>
                            <button class="btn btn-danger delete-crew-delivery-btn" style="display:none;"><i class="fa fa-trash"></i></button>
                        </td>
                        <td data-editable-select="true">
                            <select class="default-select form-control" id="crewType" name="crew_type">
                                <option value="A1" selected>A1</option>
                                <option value="A2">A2</option>
                                <option value="A3">A3</option>
                            </select>
                        </td>
                            <td data-editable="true">
                                <input type="text" class="form-control employee-name" id="employeeName" name="employee" style="width: 140px;">
                                <input type="hidden" id="employeeId" name="employee_id"> <!-- Hidden input for employee ID -->
                                <ul class="employee-delivery-dropdown" style="display:none;"></ul>
                            </td>
                        <td data-editable="true"><input type="text" class="form-control" name="no_of_days"></td>
                        <td data-editable="true"><input type="text" class="form-control" name="perday_charges"></td>
                        <td data-editable="true"><input type="text" class="form-control" name="total"></td>
                        <td data-editable="true"><input type="text" class="form-control" name="crew_notes"></td>
                    </tr>
                `;

                const $newRow = $(newRow); // Wrap the string with jQuery to create a jQuery object
                $('#crew-allocation-delivery-table-body').prepend($newRow); // Append the new row to the table

                activateDeliveryEditMode($newRow); // Activate edit mode for the new row

                // Set 'A1' as the default selected value when the row is added
                $newRow.find('select').val('A1');
            });

            $(document).on('click', '.edit-crew-delivery-btn', function (event) {
                event.preventDefault();
                const $row = $(this).closest('.editable-row');

                // Get the crewId from the data attribute
                const crewId = $row.data('crew-id');
                console.log('Crew ID:', crewId);  // You can now use the crewId as needed

                // Get current values
                const crewType = $row.find('td').eq(1).text();
                const Employee = $row.find('td').eq(2).text();
                const employeeId = $row.find('input[name="empId"]').val(); // Get employee ID from hidden field
                const noOfDays = $row.find('td').eq(3).text();
                const perDayCharges = $row.find('td').eq(4).text();
                const total = $row.find('td').eq(5).text();
                const crewNotes = $row.find('td').eq(6).text();
                console.log('check the employeeId:', employeeId)
                console.log('check the employeeId:', crewType, Employee, employeeId)

                // You should also get the stored employeeId from the hidden field (if already there)


                // Replace text with input fields
                $row.find('td').eq(1).html(`
                    <select class="default-select form-control" name="crew_type">
                        <option value="A1" ${crewType === 'A1' ? 'selected' : ''}>A1</option>
                        <option value="A2" ${crewType === 'A2' ? 'selected' : ''}>A2</option>
                        <option value="A3" ${crewType === 'A3' ? 'selected' : ''}>A3</option>
                    </select>
                `);
                $row.find('td').eq(2).html(`
                    <input type="text" class="form-control employee-name" id="employeeName" name="employee" value="${Employee}" style="width: 83px;">
                    <input type="hidden" id="employeeId" name="employee_id" value="${employeeId}"> <!-- Hidden input for employee ID -->

                `);
                $row.find('td').eq(3).html(`<input type="text" class="form-control" name="no_of_days" value="${noOfDays}" style="width: 83px;">`);
                $row.find('td').eq(4).html(`<input type="text" class="form-control" name="perday_charges" value="${perDayCharges}">`);
                $row.find('td').eq(5).html(`<input type="text" class="form-control" name="total" value="${total}">`);
                $row.find('td').eq(6).html(`<input type="text" class="form-control" name="crew_notes" value="${crewNotes}">`);

                // Toggle button visibility
                $row.find('.edit-crew-delivery-btn, .delete-crew-btn').hide();
                $row.find('.edit-save-delivery-btn, .edit-cancel-btn').show();
            });

            $(document).on('click', '#save-crew-delivery-allocation', function (event) {
                event.preventDefault();

                // Get the data-category-id from the row
                const $row = $(this).closest('.editable-row');
                const crewId = $row.data('crew-id');
                console.log('Check the job addition status delivery challen category ID:', crewId);

                // Get values from input fields
                const crewType = $row.find('select[name="crew_type"]').val();
                const Employee = $row.find('input[name="employee_id"]').val(); // Get employee ID
                const noOfDays = $row.find('input[name="no_of_days"]').val();
                const perDayCharges = $row.find('input[name="perday_charges"]').val();
                const total = $row.find('input[name="total"]').val();
                const crewNotes = $row.find('input[name="crew_notes"]').val();

                console.log('check the status delivery challen crew Type:', crewType);
                console.log('check the status delivery challen Employee:', Employee);
                console.log('check the status delivery challen No of days:', noOfDays);
                console.log('check the status delivery challen per day charges:', perDayCharges);
                console.log('check the status delivery challen total:', total);
                console.log('check the status delivery challen crew notes:', crewNotes);

                // Send AJAX request to update the database
                $.ajax({
                    type: 'POST',
                    url: '/update-crew-allocation-delivery/',
                    data: {
                        'id': crewId,
                        'crew_type': crewType,
                        'employee_name': Employee,
                        'no_of_days': noOfDays,
                        'perday_charges': perDayCharges,
                        'total': total,
                        'crew_notes': crewNotes,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        if (response.success) {
                            console.log('check the response:', response)
                            // Optionally, update the row text with new values
                            $row.find('td').eq(1).text(crewType);
                            $row.find('td').eq(2).text(Employee);
                            $row.find('td').eq(3).text(noOfDays);
                            $row.find('td').eq(4).text(perDayCharges);
                            $row.find('td').eq(5).text(total);
                            $row.find('td').eq(6).text(crewNotes);

                            fetchCrewAllocation(jobId);

                            // Hide save and cancel buttons, show edit and delete buttons
                            $row.find('.edit-save-delivery-btn, .edit-cancel-delivery-btn').hide();
                            $row.find('.edit-crew-delivery-btn, .delete-crew-delivery-btn').show();
                            console.log('update successfully:')
                        } else {
                            alert('Update failed: ' + response.error);
                        }
                    },
                    error: function () {
                        alert('An error occurred while updating the crew allocation.');
                    }
                });
            });

            $(document).on('click', '.save-crew-delivery-btn', function (event) {
                event.preventDefault();

                const $row = $(this).closest('tr');

                // Get the values from the row inputs
                const crewType = $row.find('select[name="crew_type"]').val();
                const Employee = $row.find('input[name="employee_id"]').val();
                const noOfDays = $row.find('input[name="no_of_days"]').val();
                const perDayCharges = $row.find('input[name="perday_charges"]').val();
                const total = $row.find('input[name="total"]').val();
                const crewNotes = $row.find('input[name="crew_notes"]').val();
                const tempCrewId = jobId;

                // AJAX call to save the row data to the server
                $.ajax({
                    url: '/save_crew_delivery_allocation/',
                    method: 'POST',
                    data: {
                        'temp_id': tempCrewId,
                        'crew_type': crewType,
                        'employee_name': Employee,
                        'crew_no_of_days': noOfDays,
                        'perday_charges': perDayCharges,
                        'total': total,
                        'crew_notes': crewNotes,
                        'csrfmiddlewaretoken': getCsrfToken() // Use the function here
                    },
                    success: function (response) {
                        if (response.status === 'success') {
                            alert('Crew allocation saved successfully');

                            // Use the employee name from the response instead of employee ID
                            const employeeName = response.emp_name;

                            // Create a new row in the desired format
                            const newRow = `
                                <tr class="editable-row-delivery" data-category-id="${response.crew_allocation_id}">
                                    <td style="width: 40px;">
                                        <button class="btn btn-sm btn-primary edit-crew-delivery-btn me-2" data-toggle="tooltip" title="Edit Delivery"><i class="fa fa-pencil"></i></button>
                                        <button class="btn btn-sm btn-success edit-save-delivery-btn me-2" style="display:none;" data-toggle="tooltip" title="Save Delivery" id="save-crew-delivery-allocation"><i class="fa fa-save"></i></button>
                                        <button class="btn btn-sm btn-secondary edit-cancel-delivery-btn me-2" style="display:none;" data-toggle="tooltip" title="Cancel Delivery" id="cancel-crew-allocation"><i class="fa fa-times"></i></button>
                                        <button class="btn btn-sm btn-danger delete-crew-delivery-btn me-2" data-toggle="tooltip" title="Delete Delivery"><i class="fa fa-trash"></i></button>
                                    </td>
                                    <td style="font-size: 14px;">${crewType}</td>
                                    <td style="font-size: 14px;">${employeeName}</td>
                                    <td style="font-size: 14px;">${noOfDays}</td>
                                    <td style="font-size: 14px;">${perDayCharges}</td>
                                    <td style="font-size: 14px;">${total}</td>
                                    <td style="font-size: 14px;">${crewNotes}</td>
                                </tr>
                            `;

                            // Replace the existing row with the new row HTML
                            $row.replaceWith(newRow);
                        } else if (response.status === 'error' && response.message === 'Crew allocation already exists') {
                            // Show alert if crew allocation already exists
                            alert(response.message);  // Show the exact message returned from the server
                        } else {
                            alert('Failed to save crew allocation');
                        }
                    },
                    error: function (xhr, status, error) {
                        const response = xhr.responseJSON;
                        if (response && response.status === 'error') {
                            alert(response.message); // Handle error from server
                        } else {
                            alert('An error occurred while saving the crew allocation.');
                        }
                    }
                });
            });

            // Crew Allocation Section End

            // Transporation Allocation Section
            // Attach event handler to the Cancel button

            fetchTransportationDetails(jobId);

            function fetchTransportationDetails(jobId) {
                fetch(`/get_transportation_allocation/?jobId=${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        populateFields(data);
                    })
                    .catch(error => console.error('Error fetching transportation details:', error));
            }

            function populateFields(data) {
                var onVehicleFields = document.getElementById('onVehicleFields');
                var outsideVehicleFields = document.getElementById('outsideVehicleFields');

                onVehicleFields.innerHTML = '';
                outsideVehicleFields.innerHTML = '';

                let onVehicleChecked = false;
                let outsideVehicleChecked = false;

                data.forEach(item => {
                    if (item.driver_name || item.vehicle_number) {
                        onVehicleChecked = true;
                        var newRowHtml = `
                            <div class="row transportation-row on-vehicle-row" data-id="${item.id}">
                                <div class="col-xl-4 mb-3">
                                    <label class="form-label">Driver Name</label>
                                    <input type="text" class="form-control" placeholder="Enter Driver Name" name="driver_name" value="${item.driver_name || ''}">
                                </div>
                                <div class="col-xl-3 mb-3">
                                    <label class="form-label">Contact Number</label>
                                    <input type="number" class="form-control" placeholder="Enter Contact Number" name="contact_number" value="${item.contact_number || ''}">
                                </div>
                                <div class="col-xl-3 mb-3">
                                    <label class="form-label">Vehicle Number</label>
                                    <input type="text" class="form-control" id="vehicle-number-field" placeholder="Enter Vehicle Number" name="vehicle_number" value="${item.vehicle_number || ''}">
                                </div>
                                <div class="col-xl-2 mb-3" style="margin-top: 36px;">
                                    <button type="button" class="btn btn-success updateRow"><i class="fa fa-save"></i></button>
                                    <button type="button" class="btn btn-danger light cancelRow"><i class="fa fa-times"></i></button>
                                </div>
                            </div>
                        `;
                        onVehicleFields.insertAdjacentHTML('beforeend', newRowHtml);
                    }

                    if (item.outside_driver_name || item.outside_vehicle_number) {
                        outsideVehicleChecked = true;
                        var newOutSideRowHtml = `
                            <div class="row transportation-row outside-vehicle-row" data-id="${item.id}">
                                <div class="col-xl-4 mb-3">
                                    <label class="form-label">Outside Driver Name</label>
                                    <input type="text" class="form-control" placeholder="Enter Driver Name" name="outside_driver_name" value="${item.outside_driver_name || ''}">
                                </div>
                                <div class="col-xl-3 mb-3">
                                    <label class="form-label">Outside Contact Number</label>
                                    <input type="number" class="form-control" placeholder="Enter Contact Number" name="outside_contact_number" value="${item.outside_contact_number || ''}">
                                </div>
                                <div class="col-xl-3 mb-3">
                                    <label class="form-label vehicle-number-field">Outside Vehicle Number</label>
                                    <input type="text" class="form-control" placeholder="Enter Vehicle Number" name="outside_vehicle_number" value="${item.outside_vehicle_number || ''}">
                                </div>
                                <div class="col-xl-2 mb-3" style="margin-top: 36px;">
                                    <button type="button" class="btn btn-success updateRow"><i class="fa fa-save"></i></button>
                                    <button type="button" class="btn btn-danger light cancelRow"><i class="fa fa-times"></i></button>
                                </div>
                            </div>
                        `;
                        outsideVehicleFields.insertAdjacentHTML('beforeend', newOutSideRowHtml);
                    }
                });

                if (onVehicleChecked) {
                    document.getElementById('onVehicle').checked = true;
                    document.getElementById('onVehicleFields').style.display = 'block';
                }
                if (outsideVehicleChecked) {
                    document.getElementById('outsideVehicle').checked = true;
                    document.getElementById('outsideVehicleFields').style.display = 'block';
                }

                document.querySelectorAll('input[name="transportation_type"]').forEach(radio => {
                    radio.addEventListener('change', function () {
                        if (this.value === 'on_vehicle') {
                            document.getElementById('onVehicleFields').style.display = 'block';
                            document.getElementById('outsideVehicleFields').style.display = 'none';
                        } else if (this.value === 'outside_vehicle') {
                            document.getElementById('onVehicleFields').style.display = 'none';
                            document.getElementById('outsideVehicleFields').style.display = 'block';
                        }
                    });
                });

                document.querySelector('input[name="transportation_type"]:checked')?.dispatchEvent(new Event('change'));

                document.querySelectorAll('.updateRow').forEach(button => {
                    button.addEventListener('click', function () {
                        var row = this.closest('.transportation-row');
                        var rowId = row.getAttribute('data-id');
                        var data = {
                            id: rowId,
                            driver_name: row.querySelector('input[name="driver_name"]') ? row.querySelector('input[name="driver_name"]').value : null,
                            contact_number: row.querySelector('input[name="contact_number"]') ? row.querySelector('input[name="contact_number"]').value : null,
                            vehicle_number: row.querySelector('input[name="vehicle_number"]') ? row.querySelector('input[name="vehicle_number"]').value : null,
                            outside_driver_name: row.querySelector('input[name="outside_driver_name"]') ? row.querySelector('input[name="outside_driver_name"]').value : null,
                            outside_contact_number: row.querySelector('input[name="outside_contact_number"]') ? row.querySelector('input[name="outside_contact_number"]').value : null,
                            outside_vehicle_number: row.querySelector('input[name="outside_vehicle_number"]') ? row.querySelector('input[name="outside_vehicle_number"]').value : null
                        };
                        updateRow(data);
                    });
                });

                document.querySelectorAll('.cancelRow').forEach(button => {
                    button.addEventListener('click', function () {
                        var row = this.closest('.transportation-row');
                        var rowId = row.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this row?')) {
                            row.remove();
                            // Optionally send a request to the server to delete the row
                            deleteRow(rowId);
                        }
                    });
                });
            }

            function deleteRow(rowId) {
                fetch(`/delete_transportation_allocation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken() // Ensure you have a function to get the CSRF token
                    },
                    body: JSON.stringify({id: rowId})
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert('Row deleted successfully');
                        } else {
                            alert('Error deleting row: ' + result.error);
                        }
                    })
                    .catch(error => console.error('Error deleting row:', error));
            }

            function updateRow(data) {
                fetch(`/update_transportation_allocation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken() // Ensure you have a function to get the CSRF token
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert('Row updated successfully');
                        } else {
                            alert('Error updating row: ' + result.error);
                        }
                    })
                    .catch(error => console.error('Error updating row:', error));
            }

            function getCsrfToken() {
                const name = 'csrftoken=';
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name)) {
                        return cookie.substring(name.length, cookie.length);
                    }
                }
                return ''; // Return an empty string if CSRF token is not found
            }

            // Add new transportation row when "Add More" button is clicked
            $('#addTransportation').click(function (event) {
                event.preventDefault(); // Prevent the default form submission

                // Get the selected transportation type
                var transportationType = $('input[name="transportation_type"]:checked').val();

                // Define the HTML for a new row
                var newRowHtml = `
                    <div class="row transportation-row ${transportationType === 'on_vehicle' ? 'on-vehicle-row' : 'outside-vehicle-row'}">
                        <div class="col-xl-4 mb-3">
                            <label class="form-label">${transportationType === 'on_vehicle' ? 'Driver Name' : 'Outside Driver Name'}</label>
                            <input type="text" class="form-control" placeholder="Enter Driver Name" name="${transportationType === 'on_vehicle' ? 'driver_name' : 'outside_driver_name'}">
                        </div>
                        <div class="col-xl-3 mb-3">
                            <label class="form-label">${transportationType === 'on_vehicle' ? 'Contact Number' : 'Outside Contact Number'}</label>
                            <input type="number" class="form-control" placeholder="Enter Contact Number" name="${transportationType === 'on_vehicle' ? 'contact_number' : 'outside_contact_number'}">
                        </div>
                        <div class="col-xl-3 mb-3">
                            <label class="form-label">${transportationType === 'on_vehicle' ? 'Vehicle Number' : 'Outside Vehicle Number'}</label>
                            <input type="text" class="form-control" placeholder="Enter Vehicle Number" name="${transportationType === 'on_vehicle' ? 'vehicle_number' : 'outside_vehicle_number'}">
                        </div>
                        <div class="col-xl-2 mb-3" style="margin-top: 36px;">
                            <button type="button" class="btn btn-success saveRow" data-type="${transportationType}"><i class="fa fa-save"></i></button>
                            <button type="button" class="btn btn-danger light cancelRow"><i class="fa fa-times"></i></button>
                        </div>
                    </div>
                `;

                // Append the new row to the appropriate section
                if (transportationType === 'on_vehicle') {
                    $('#onVehicleFields').append(newRowHtml);
                } else if (transportationType === 'outside_vehicle') {
                    $('#outsideVehicleFields').append(newRowHtml);
                }
            });

            // Event listener to remove a row when the cancelRow button is clicked
            $(document).on('click', '.cancelRow', function () {
                $(this).closest('.transportation-row').remove();
            });

            // Add event listener to dynamically created 'saveRow' buttons
            $(document).on('click', '.saveRow', function (event) {
                var button = $(this);
                var row = button.closest('.row');
                var type = button.data('type'); // Get the type of transportation

                var data = {
                    temp_id: jobId,
                    driver_name: '',
                    contact_number: '',
                    vehicle_number: '',
                    outside_driver_name: '',
                    outside_contact_number: '',
                    outside_vehicle_number: ''
                };

                // Collect data based on transportation type
                if (type === 'on_vehicle') {
                    data.driver_name = row.find('input[name="driver_name"]').val();
                    data.contact_number = row.find('input[name="contact_number"]').val();
                    data.vehicle_number = row.find('input[name="vehicle_number"]').val();
                } else if (type === 'outside_vehicle') {
                    data.outside_driver_name = row.find('input[name="outside_driver_name"]').val();
                    data.outside_contact_number = row.find('input[name="outside_contact_number"]').val();
                    data.outside_vehicle_number = row.find('input[name="outside_vehicle_number"]').val();
                }

                $.ajax({
                    url: '/insert_transportation/', // Replace with your actual URL
                    type: 'POST',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    success: function (response) {
                        alert('Data saved successfully!');
                        // Optionally provide feedback or update the UI without removing the row
                    },
                    error: function (xhr, status, error) {
                        alert('An error occurred: ' + error);
                    }
                });
            });

            $('#removeButton').click(function (event) {
                event.preventDefault(); // Prevent the default form submission
                // Clear the form fields
                $('#onVehicleFields').find('input').val('');
                $('#outsideVehicleFields').find('input').val('');
            });

            // Event handler for the '#shareAsPdf' button click
            $('#shareAsPdf').click(function () {
                var jobId = getJobIdFromURL(); // Fetch the jobId from the URL
                console.log('Fetch the Job ID:', jobId);

                if (jobId) {
                    $.ajax({
                        url: '/print_jobs/', // Your Django URL for fetching job details
                        type: 'GET',
                        data: {jobId: jobId},
                        success: function (response) {
                            if (response.job && response.job.status) {
                                var status = response.job.status.toLowerCase();
                                if (status === 'quotation') {
                                    // Show dropdown container
                                    $('#dropdown-container').show();

                                    // Handle dropdown item click
                                    $('#dropdown-container .dropdown-item').off('click').on('click', function () {
                                        var selectedOptionId = $(this).attr('id'); // Get the id of the selected option

                                        // Hide the dropdown container after selection
                                        $('#dropdown-container').hide();

                                        // Clear previous event listeners from #pdfOption and #printOption
                                        $('#delivery-options-container #pdfOption').off('click');
                                        $('#delivery-options-container #printOption').off('click');

                                        // Check the id and call the appropriate function
                                        if (selectedOptionId === "equipmentQuotation") {
                                            $('#delivery-options-container').show();

                                            // Handle the click on the PDF option
                                            $('#delivery-options-container #pdfOption').on('click', function () {
                                                handleEquipmentQuotationPdf(response);

                                                $('#delivery-options-container').hide(); // Hide options after selection
                                            });

                                            // Handle the click on the Print option
                                            $('#delivery-options-container #printOption').on('click', function () {
                                                handleEquipmentQuotation(response);

                                                $('#delivery-options-container').hide(); // Hide options after selection
                                            });

                                        } else if (selectedOptionId === "totalQuotation") {
                                            $('#delivery-options-container').show();

                                            // Handle the click on the PDF option
                                            $('#delivery-options-container #pdfOption').on('click', function () {
                                                handleTotalQuotationPdf(response);

                                                $('#delivery-options-container').hide(); // Hide options after selection
                                            });

                                            // Handle the click on the Print option
                                            $('#delivery-options-container #printOption').on('click', function () {
                                                handleTotalQuotation(response);

                                                $('#delivery-options-container').hide(); // Hide options after selection
                                            });
                                        }
                                    });

                                } else if (status === 'porforma') {
                                    // Show PDF and Print options
                                    $('#porforma-options-container').show();

                                    // Clear previous event listeners from #pdfOption and #printOption
                                    $('#porforma-options-container #porformaPdfOption').off('click');
                                    $('#porforma-options-container #porformaPrintOption').off('click');

                                    // Handle the click on the PDF option
                                    $('#porforma-options-container #porformaPdfOption').on('click', function () {
                                        handleDeliveryChallanPdf(response);

                                        $('#porforma-options-container').hide(); // Hide options after selection
                                    });

                                    // Handle the click on the Print option
                                    $('#porforma-options-container #porformaPrintOption').on('click', function () {
                                        handlePerfoma(response);

                                        $('#porforma-options-container').hide(); // Hide options after selection
                                    });

                                } else if (status === 'prepsheet') {
                                    // Show PDF and Print options
                                    $('#prepsheet-options-container').show();

                                    // Clear previous event listeners from #pdfOption and #printOption
                                    $('#prepsheet-options-container #prepsheetPdfOption').off('click');
                                    $('#prepsheet-options-container #prepsheetPrintOption').off('click');

                                    // Handle the click on the PDF option
                                    $('#prepsheet-options-container #prepsheetPdfOption').on('click', function () {
                                        handleDeliveryChallanPdf(response);

                                        $('#prepsheet-options-container').hide(); // Hide options after selection
                                    });

                                    // Handle the click on the Print option
                                    $('#prepsheet-options-container #prepsheetPrintOption').on('click', function () {
                                        handlePrepsheet(response);

                                        $('#prepsheet-options-container').hide(); // Hide options after selection
                                    });

                                } else if (status === 'delivery challan') {
                                    // Show PDF and Print options
                                    $('#delivery-options-container').show();

                                    // Clear previous event listeners from #pdfOption and #printOption
                                    $('#delivery-options-container #pdfOption').off('click');
                                    $('#delivery-options-container #printOption').off('click');

                                    // Handle the click on the PDF option
                                    $('#delivery-options-container #pdfOption').on('click', function () {
                                        handleDeliveryChallanPdf(response);

                                        $('#delivery-options-container').hide(); // Hide options after selection
                                    });

                                    // Handle the click on the Print option
                                    $('#delivery-options-container #printOption').on('click', function () {
                                        handleDeliveryChallan(response);

                                        $('#delivery-options-container').hide(); // Hide options after selection
                                    });
                                } else {
                                    alert('Unknown status: ' + response.job.status);
                                }
                            } else {
                                alert('Job status not found in response.');
                            }
                        },
                        error: function (error) {
                            console.error('Error fetching job details:', error);
                            alert('Error fetching job details. Please try again.');
                        }
                    });
                } else {
                    alert('No jobId found in URL.');
                }

                // Hide dropdown if clicking outside of it
                $(document).click(function (event) {
                    if (!$(event.target).closest('#dropdown-container, #shareAsPdf').length) {
                        $('#dropdown-container').hide();
                    }
                });

                // Prevent hiding the dropdown when clicking inside it
                $('#dropdown-container').click(function (event) {
                    event.stopPropagation();
                });
            });

            function handleEquipmentQuotation(response) {

    let equipmentDetailsHtml = "";
    let processedIds = new Set();

    response.equipment_details.forEach(function(detail) {
        if (!processedIds.has(detail.equipment_detail_id)) {
            processedIds.add(detail.equipment_detail_id);

            // Generate equipment details HTML for each unique equipment_detail_id
            let equipmentTableHtml = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                    <thead>
                        <tr>
                            <th style="width: 25%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Equipment Name</th>
                        <th style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Qty</th>
                        <th style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Per Unit</th>
                        <th style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Days</th>
                        <th style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Total</th>
                        <th style="width: 45%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Loop through and add only rows matching this equipment_detail_id
            response.equipment_details
                .filter(item => item.equipment_detail_id === detail.equipment_detail_id)
                .forEach(function(item) {
                    equipmentTableHtml += `
                        <tr>
                            <td style="width: 25%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${item.equipment_name}</td>
                    <td style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${item.quantity}</td>
                    <td style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${item.rental_price}</td>
                    <td style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${response.total_days}</td>
                    <td style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${item.total_rental_price}</td>
                    <td style="width: 45%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${item.equipment_notes}</td>
                        </tr>
                    `;
                });

            equipmentTableHtml += `
                    </tbody>
                </table>
            `;

            equipmentDetailsHtml += `
                <div class="equipment-details">
                    <div class="equipment_left" style="width: 700px;">
                        <p><b>Equipment Title:</b><span> ${response.job.title}</span>:<span>${detail.equipment_detail_id}</span></p>
                        <p><b>Equipment Ref:</b><span> ${detail.equipment_detail_id}</span></p>
                        <p><b>Location:</b><span> ${detail.location}</span></p>
                        <p><b>Event Start Date:</b><span> ${detail.equipment_setup_date}</span></p>
                        <p><b>Event End Date:</b><span> ${detail.equipment_rehearsal_date}</span></p>
                    </div>
                    <div class="equipment_right" style="width: 300px;">
                        <p><b>Show Start Date:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                        <p><b>Setup Date:</b><span> ${response.job.setup_date}</span></p>
                        <p><b>Show End Date:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                        <p><b>Pack Up Date:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                    </div>

                </div>
<div class="job-details-description">
            <div class="job-container">

                </div>
                <h2 id="color" style="margin-top: 10px;">AUDIO EQUIPMENT</h2>

                        ${equipmentTableHtml}

            </div>
            `;
        }
    });


                var printContent = `
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <style>
                                .box {
                                    background-color: #fff;
                                    padding: 20px;
                                    margin: -35px auto;
                                    max-width: 700px;
                                    min-height: 100%;
                                }
                                .container {
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    padding: 0;
                                }
                                .left {
                                    width: 150px;
                                    text-align: left;
                                }
                                .right {
                                    width: 150px;
                                    text-align: left;

                                }
                                .left p {
                                    margin-bottom: 4px;
                                }
                                .left h3 {
                                    margin-bottom: -10px;
                                }
                                .left h5 {
                                    margin-top: 5px;
                                }
                                .right p {
                                    margin-bottom: 4px;
                                }
                                .right h3 {
                                    margin-bottom: -10px;
                                }
                                .right h5 {
                                    margin-top: 5px;
                                }
                                .logo {
                                    width: 200px;
                                    align-item: center;
                                }
                                .job-details {
                                    display: flex;
                                    border-top: 1px solid #000000;
                                    margin-top: -22px;
                                    justify-content: space-between;
                                    height: auto;
                                }
                                .equipment-details {
                display: flex;
                border-top: 10px solid #d1e0d3;
                margin-top: 20px;
                padding-top: 10px;
                justify-content: space-between;
                height: auto;
            }

            .equipment_left {
                display: flex;
                flex-direction: column;
                margin-top: -15px;
            }

            .equipment_left p {
                margin-bottom: -8px; /* Adjusted margin for better spacing */
            }

            .equipment_left p b {
                display: inline-block;
                width: 100px; /* Fixed width for labels to align values */
            }

            .equipment_left p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
            .equipment_right {
                display: flex;
                flex-direction: column;
                margin-top: -15px;
            }

            .equipment_right p {
                margin-bottom: -8px; /* Adjusted margin for better spacing */
            }

            .equipment_right p b {
                display: inline-block;
                width: 100px; /* Fixed width for labels to align values */
            }

            .equipment_right p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
                                .job_left {
                                    display: flex;
                                    flex-direction: column;
                                }
                                .job_left p {
                                    margin-bottom: -8px;
                                }
                                .job_left p b {
                                    display: inline-block;
                                    width: 120px;
                                }
                                .job_left p span {
                                    display: inline-block;
                                    margin-left: -22px;
                                }
                                .job_right {
                                    display: flex;
                                    flex-direction: column;
                                    width: 150px; /* Maintain the width */
                                    word-wrap: break-word; /* Ensures that long text wraps to the next line */
                                }

                                .job_right p {
                                    margin-bottom: -8px;
                                    display: flex;
                                    flex-wrap: wrap;
                                }

                                .job_right p b {
                                    flex: 0 0 90px; /* Fixed width for the label */
                                    display: inline-block;
                                }

                                .job_right p span {
                                    flex: 1; /* Allows the span to take up remaining space */
                                    display: inline-block;
                                    word-wrap: break-word; /* Ensures text inside <span> wraps properly */
                                }
                                .job-details-description {
                                    margin-top: 15px;
                                    border-top: 1px solid #000000;
                                    display: flex;
                                    flex-direction: column;
                                    align-item: left;
                                    margin-bottom: 20px;
                                }
                                .job-details-description h4 {
                                    text-align: left;
                                }
                                .job-details-description h2 {
                                    text-align: left;
                                    margin-top: -15px;
                                }
                                .job_equipment_container {
                                    display: flex;
                                    justify-content: space-between;
                                    margin-top: -10px;
                                }
                                .job_left_equipment {
                                    width: 45%;
                                }
                                .job_right_equipment {
                                    width: 45%;
                                    float: right;
                                    text-align: right;
                                }
                                .color-amount{
                                    background-color: #b5c3c9;
                                }
                                #color {
                background-color: #bfcddb;
                color: #0b0c0f;
                border-bottom: 1px solid #000000;
                font-style: italic;
            }
            .customer-details {
                display: inline-block;
                vertical-align: top;
                max-width: 150px;
            }
            .company-address {
                margin-top: 5px;
                word-wrap: break-word;
            }
                                @page {
                                    size: A4;
                                    margin: 0;
                                }
                                body {
                                    margin: 0;
                                    font-size: 10pt;
                                    background-color: white;
                                }
                                @media only screen and (max-width: 300px) {
                                    .container {
                                        flex-direction: column;
                                        align-items: center;
                                    }
                                    .job-details {
                                        width: 100%;
                                    }
                                    .job_left,
                                    .job_right {
                                        width: 100%;
                                        text-align: center;
                                    }
                                }
@page {
    size: A4;
    margin: 0.5cm;
}

body {
    margin: 0;
    font-size: 10pt;
    background-color: #FFFFFF;
    padding: 1cm; }

.table-container {
    page-break-inside: avoid;
}

.equipment-details,
.job-details,
.job-details-description {
    page-break-inside: avoid; }
                            </style>
                        </head>
                        <body>
                            <div class="box">
                                <div class="container">
                                    <div class="left">
                                        <h3><u>Registered Address:</u></h3>
                                        <h3 style="font-size: 14px;">${response.company.company_name}</h3>
                                        <p>${response.company.address}</p>
                                        <p style="margin-top: -4px;"><a href="mailto:${response.company.email}">${response.company.email}</a></p>
                                        <h5 style="font-size: 11px;">GST No: ${response.company.gst_no}</h5>
                                    </div>
                                    <div class="logo">
                                        <img id="logoImage" src="${response.company.company_logo}" class="logo" alt="Logo" />
                                    </div>
                                    <div class="right">
                                        <h3><u>Warehouse Address:</u></h3>
                                        <h3 style="font-size: 14px;">${response.company.company_name}</h3>
                                        <p>${response.company.address}</p>
                                        <p style="margin-top: -2px;">8879984118</p>
                                    </div>
                                </div>
                                <div>
                                    <h3 style="text-align: center; font-size: 30px; margin-top: -35px;">${response.job.status}</h3>
                                </div>
                                <div class="job-details">
                                    <div class="job_left" style="width: 300px;">
                                        <p><b>Job Title:</b><span> ${response.job.title}</span></p>
                                        <p><b>Job Reference:</b><span> ${response.job.job_reference_no}</span></p>
                                        <p><b>Name:</b><span> ${response.job.client_name}</span></p>
                                        <p><b>Sales Person:</b><span> ${response.job.contact_person_name} - ${response.job.contact_person_number}</span></p>

                                    </div>
                                    <div class="job_right" style="width: 200px;">
                                        <p><b>Venue:</b><span> ${response.job.venue_name}<br/>${response.job.venue_address}</span></p>
                                        <p><b>Job Date Out:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                                        <p><b>Job Date Back:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                                    </div>
                                </div>

                                    ${equipmentDetailsHtml}

                                <div style="height:30px;" class="color-amount">
                                    <p style="text-align: right; color: black; margin-right: 5px; padding-top: 6px;"><b>Total for AUDIO EQUIPMENT INR RS. ${response.total_with_gst}</b></p>
                                </div>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
    <tbody>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">Total INR </td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">RS.${response.total_rental_sum}</td>
        </tr>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">After Discount INR</td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">RS.${response.total_after_discount}</td>
        </tr>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">Total Amount with 18% GST INR</td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">RS.${response.total_with_gst}</td>
        </tr>
    </tbody>
</table>


                            </div>
                        </body>
                        </html>
                    `;

                // Open the print window
                var printWindow = window.open('', '_blank');
                printWindow.document.open();
                printWindow.document.write(printContent);
                printWindow.document.close();

                // Wait for the content to load and then print
                printWindow.onload = function () {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                };
            }

            function handleEquipmentQuotationPdf(response) {
                let equipmentDetailsHtml = "";
    let processedIds = new Set();

    response.equipment_details.forEach(function(detail) {
        if (!processedIds.has(detail.equipment_detail_id)) {
            processedIds.add(detail.equipment_detail_id);

            // Generate equipment details HTML for each unique equipment_detail_id
            let equipmentTableHtml = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                    <thead>
                        <tr>
                            <th style="width: 25%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Equipment Name</th>
                    <th style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Qty</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Per Unit</th>
                    <th style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Days</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Total</th>
                    <th style="width: 45%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Loop through and add only rows matching this equipment_detail_id
            response.equipment_details
                .filter(item => item.equipment_detail_id === detail.equipment_detail_id)
                .forEach(function(item) {
                    equipmentTableHtml += `
                        <tr>
                             <td style="width: 25%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${detail.equipment_name}</td>
                <td style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${detail.quantity}</td>
                <td style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${detail.rental_price}</td>
                <td style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${response.total_days}</td>
                <td style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${detail.total_rental_price}</td>
                <td style="width: 45%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${detail.equipment_notes}</td>
                        </tr>
                    `;
                });

            equipmentTableHtml += `
                    </tbody>
                </table>
            `;

            equipmentDetailsHtml += `
                <div class="equipment-details">
                    <div class="equipment_left" style="width: 700px;">
                        <p><b>Equipment Title:</b><span> ${response.job.title}</span>:<span>${detail.equipment_detail_id}</span></p>
                        <p><b>Equipment Ref:</b><span> ${detail.equipment_detail_id}</span></p>
                        <p><b>Location:</b><span> ${detail.location}</span></p>
                        <p><b>Event Start Date:</b><span> ${detail.equipment_setup_date}</span></p>
                        <p><b>Event End Date:</b><span> ${detail.equipment_rehearsal_date}</span></p>
                    </div>
                    <div class="equipment_right" style="width: 300px;">
                        <p><b>Show Start Date:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                        <p><b>Setup Date:</b><span> ${response.job.setup_date}</span></p>
                        <p><b>Show End Date:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                        <p><b>Pack Up Date:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                    </div>

                </div>
<div class="job-details-description">
            <div class="job-container">

                </div>
                <h3 id="color" style="margin-top: 10px;">AUDIO EQUIPMENT</h3>

                        ${equipmentTableHtml}

            </div>
            `;
        }
    });

                var printContent = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            .box {
                background-color: #fff;
                padding: 10px;
                margin: 5px auto;
                max-width: 90%;
                min-height: 100%;
            }
            .container {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .left {
                width: 150px;
                text-align: left;
                color: black;
                height: auto;

            }
            .left h4 u {
                color: #0c0c0c;
            }
            .left p {
                margin-bottom: 0px;
            }
            .left p a {
                color: #2881b5;
            }

            .right {
                width: 150px;
                text-align: left;
                margin-top: 30px;
                color: black;
                height: auto;
            }
            .right h4 {
                margin-bottom: 2px;
            }
            .right h4 u {
                color: #0c0c0c;
            }
            .right p {
                margin-bottom: 0px;
            }
            .logo {
                width: 145px;
                align-item: center;
            }
            .job-details {
                display: flex;
                border-top: 1px solid #000000;
                margin-top: -16px;
                padding-top: -5px;
                justify-content: space-between;
                height: auto;
                color: black;
            }
            .equipment-details {
                display: flex;
                border-top: 8px solid #d1e0d3;
                margin-top: 20px;
                padding-top: 10px;
                justify-content: space-between;
                height: auto;
                font-size: 12px;
            }

            .equipment_left {
                display: flex;
                flex-direction: column;
                margin-top: -2px;
                justify-content: space-between;
                color: #1a1d20;

            }

            .equipment_left p {
                margin-bottom: 0; /* Adjusted margin for better spacing */
            }

            .equipment_left p b {
                display: inline-block;
                width: 110px; /* Fixed width for labels to align values */
            }
            .equipment_left b{
                font-size: 12px;
                color: #0c0c0c;
            }

            .equipment_left p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
            .equipment_right {
                display: flex;
                flex-direction: column;
                margin-top: -2px;
                justify-content: space-between;
                color: #1a1d20;
            }

            .equipment_right p {
                margin-bottom: 0; /* Adjusted margin for better spacing */
            }

            .equipment_right p b {
                display: inline-block;
                width: 110px; /* Fixed width for labels to align values */
            }

            .equipment_right p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
            .equipment_right b{
                font-size: 12px;
                color: #0c0c0c;
            }
            .job_left {
                display: flex;
                flex-direction: column;
            }
            .job_left p {
                margin-bottom: 0px;
                font-size: 11px;
            }
            .job_left p b {
                display: inline-block;
                width: 110px;
            }
            .job_left p span {
                display: inline-block;
                margin-left: -22px;
            }
            .job_right {
                display: flex;
                flex-direction: column;
                width: 150px; /* Maintain the width */
                word-wrap: break-word; /* Ensures that long text wraps to the next line */
            }
            .job_right p {
                font-size: 11px;
                margin-bottom: 0px;
                display: flex;
                flex-wrap: wrap;
            }
            .job_right p b {
                flex: 0 0 100px; /* Fixed width for the label */
                display: inline-block;
            }
            .job_right p span {
                flex: 1; /* Allows the span to take up remaining space */
                display: inline-block;
                word-wrap: break-word; /* Ensures text inside <span> wraps properly */
            }
            .job-details-description {
                margin-top: 30px;
                border-top: 1px solid #000000;
                display: flex;
                flex-direction: column;
                align-item: left;
                margin-bottom: 20px;
            }
            .job-details-description h4 {
                text-align: left;
                margin-top: 10px;
            }
            .job-details-description h2 {
                text-align: left;
                margin-top: -15px;
            }
            .job_equipment_container {
                display: flex;
                justify-content: space-between;
                margin-top: -10px;
                color: #0c0c0c;
            }
            .job_left_equipment {
                width: 45%;
            }
            .job_right_equipment {
                width: 45%;
                float: right;
                text-align: right;
            }
            .color-amount {
                background-color: #bfcddb;
            }
            .job-container {
                display: flex;
                justify-content: space-between; /* Ensures that h4 and p are spaced apart */
                align-items: center; /* Centers items vertically within the div */
            }
            .job-details-left {
                margin-top: 10px; /* Removes default margin */
            }
            .job-details-center {
                margin: 0; /* Removes default margin */
                text-align: center; /* Centers text inside the paragraph */
                flex: 1; /* Allows the paragraph to take up remaining space */
            }
            #default-text {
                font-size: 20px;
                font-weight: bolder;
                margin-top: auto;
                text-decoration: underline;
            }
            #color {
                background-color: #bfcddb;
                color: #0b0c0f;
                border-bottom: 1px solid #000000;
                font-style: italic;
            }
            .customer-details {
                display: inline-block;
                vertical-align: top;
                max-width: 150px;
            }
            .company-address {
                margin-top: 5px;
                word-wrap: break-word;
            }
            @page {
                size: A4;
                margin: 0;
            }
            body {
                margin: 0px;
                font-size: 10pt;
                {#background-color: #FFFFFF;#}
                padding: 0px;
            }
            @media only screen and (max-width: 500px) {
                .container {
                    flex-direction: column;
                    align-items: center;
                }
                .job-details {
                    width: 100%;
                }
                .job_left,
                .job_right {
                    width: 100%;
                    text-align: center;
                }

            }
        </style>
    </head>
    <body>
        <div class="box">
            <div class="container">
                <div class="left">
                    <h4 style="font-size: 12px; font-weight: bolder; margin-bottom: 2px;"><u>Registered Address:</u></h4>
                    <p style="font-size: 11px; font-weight: bold;">${response.company.company_name}</p>
                    <p style="font-size: 11px;">${response.company.address}</p>
                    <p style="font-size: 11px;><a href="mailto:${response.company.email}" style="background-color: black; color: #2881b5;">${response.company.email}</a></p>
                    <p style="font-size: 11px; font-weight: bold;">GST No: ${response.company.gst_no}</p>
                </div>
                <div class="logo">
                    <img id="logoImage" src="${response.company.company_logo}" class="logo" alt="Logo" />
                </div>
                <div class="right">
                    <h4 style="font-size: 12px; font-weight: bolder; margin-bottom: 2px;"><u>Warehouse Address:</u></h4>
                    <p style="font-size: 11px; font-weight: bold;">Echoes</p>
                    <p style="font-size: 11px;">F-37, Kailas Industrial Complex, Building no.1, Near Satara Bank, Veer Savarkar Road, Park Site, Vikhroli (W), Mumbai, 400079</p>
                    <p style="font-size: 11px;">9029884368</p>
                </div>
            </div>
            <div>
                <p style="text-align: center; font-size: 30px; margin-top: -35px; color: 0b0c0f;">${response.job.status}</p>
            </div>
            <div class="job-details">
                <div class="job_left" style="width: 400px;">
                    <p><b>Job Title:</b><span> ${response.job.title}</span></p>
                    <p><b>Job Ref:</b><span> ${response.job.job_reference_no}</span></p>
                    <p><b>Name:</b><span> ${response.job.client_name}</span></p>

                    <p><b>Sales Person:</b><span> ${response.job.contact_person_name} - ${response.job.contact_person_number}</span></p>
                </div>
                <div class="job_right" style="width: 200px;">
                    <p><b>Venue:</b><span> ${response.job.venue_name}<br/>${response.job.venue_address}</span></p>
                    <p><b>Job Date Out:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                    <p><b>Job Date Back:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                </div>
            </div>
             ${equipmentDetailsHtml} <!-- Include equipment details here -->
            <div style="height:30px;" class="color-amount">
                                    <p style="text-align: right; color: black; margin-right: 5px;"><b>Total for AUDIO EQUIPMENT INR RS. ${response.total_rental_sum}</b></p>
                                </div>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
    <tbody>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%; color: 050505;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: 050505;">Total INR </td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: 050505;">RS.${response.total_rental_sum}</td>
        </tr>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%; color: 050505;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: 050505;">After Discount INR</td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: 050505;">RS.${response.total_after_discount}</td>
        </tr>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%; color: 050505;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: 050505;">Total Amount with 18% GST INR</td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: 050505;">RS.${response.total_with_gst}</td>
        </tr>
    </tbody>
</table>
        </div>
    </body>
    </html>
    `;
                // Convert the HTML to a PDF and download it
                var img = new Image();
                img.src = response.company.company_logo;
                img.onload = function() {
                    // Convert the HTML to a PDF and download it after the image is loaded
                    var opt = {
                        margin: 0,
                        filename: 'Equipment Based Quotation.pdf',
                        image: {type: 'jpeg', quality: 0.98},
                        html2canvas: {scale: 2, useCORS: true},
                        jsPDF: {unit: 'in', format: 'letter', orientation: 'portrait'}
                    };

                    html2pdf().from(printContent).set(opt).save();
                };
            }

            function handleTotalQuotation(response) {
                // Construct the table HTML for equipment details
                var equipmentTableHtml = `
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr>
                    <th style="width: 25%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Equipment Name</th>
                    <th style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Qty</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Per Unit</th>
                    <th style="width: 60%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Notes</th>
                </tr>
            </thead>
            <tbody>
    `;

                response.equipment_details.forEach(function (detail) {
                    equipmentTableHtml += `
            <tr>
                <td style="width: 25%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${detail.equipment_name}</td>
                <td style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${detail.quantity}</td>
                <td style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${detail.rental_price}</td>
                <td style="width: 60%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${detail.equipment_notes} </td>
            </tr>
        `;
                });

                equipmentTableHtml += `
            </tbody>
        </table>
    `;


                var printContent = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                .box {
                    background-color: #fff;
                    padding: 20px;
                    margin: 10px auto;
                    max-width: 700px;
                    min-height: 100%;
                }
                .container {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 0px;
                }
                .left {
                    width: 150px;
                    text-align: left;
                }
                .right {
                    width: 150px;
                    text-align: right;
                }
                .left p {
                    margin-bottom: 4px;
                }
                .left h3 {
                    margin-bottom: -10px;
                }
                .left h5 {
                    margin-top: 5px;
                }
                .right p {
                    margin-bottom: 4px;
                }
                .right h3 {
                    margin-bottom: -10px;
                }
                .right h5 {
                    margin-top: 5px;
                }
                .logo {
                    width: 100px;
                    align-item: center;
                }
                .job-details {
                    display: flex;
                    border-top: 1px solid #000000;
                    margin-top: -22px;
                    justify-content: space-between;
                    height: auto;
                }
                .job_left {
                    display: flex;
                    flex-direction: column;
                }
                .job_left p {
                    margin-bottom: -8px;
                }
                .job_left p b {
                    display: inline-block;
                    width: 120px;
                }
                .job_left p span {
                    display: inline-block;
                    margin-left: -22px;
                }
.job_right {
    display: flex;
    flex-direction: column;
    width: 150px; /* Maintain the width */
    word-wrap: break-word; /* Ensures that long text wraps to the next line */
}

.job_right p {
    margin-bottom: -8px;
    display: flex;
    flex-wrap: wrap;
}

.job_right p b {
    flex: 0 0 90px; /* Fixed width for the label */
    display: inline-block;
}

.job_right p span {
    flex: 1; /* Allows the span to take up remaining space */
    display: inline-block;
    word-wrap: break-word; /* Ensures text inside <span> wraps properly */
}



                .job-details-description {
                    margin-top: 15px;
                    border-top: 1px solid #000000;
                    display: flex;
                    flex-direction: column;
                    align-item: left;
                    margin-bottom: 20px;
                }
                .job-details-description h4 {
                    text-align: left;
                }
                .job-details-description h2 {
                    text-align: left;
                    margin-top: -15px;
                }
                .job_equipment_container {
                    display: flex;
                    justify-content: space-between;
                    margin-top: -10px;
                }
                .job_left_equipment {
                    width: 45%;
                }
                .job_right_equipment {
                    width: 45%;
                    float: right;
                    text-align: right;
                }
                .color-amount{
                    background-color: #b5c3c9;
                }
                @page {
                    size: A4;
                    margin: 0;
                }
                body {
                    margin: 0;
                    font-size: 10pt;
                    background-color: white;
                }
                @media only screen and (max-width: 300px) {
                    .container {
                        flex-direction: column;
                        align-items: center;
                    }
                    .job-details {
                        width: 100%;
                    }
                    .job_left,
                    .job_right {
                        width: 100%;
                        text-align: center;
                    }
                }
            </style>
        </head>
        <body>
            <div class="box">
                <div class="container">
                    <div class="left">
                        <h3><u>Registered Address:</u></h3>
                        <h3 style="font-size: 14px;">${response.company.company_name}</h3>
                        <p>${response.company.address}</p>
                        <p style="margin-top: -4px;"><a href="mailto:${response.company.email}">${response.company.email}</a></p>
                        <h5 style="font-size: 11px;">GST No: ${response.company.gst_no}</h5>
                    </div>
                    <div class="logo">
                        <img id="logoImage" src="${response.company.company_logo}" class="logo" alt="Logo" />
                    </div>
                    <div class="right">
                        <h3><u>Warehouse Address:</u></h3>
                        <h3 style="font-size: 14px;">Echoes</h3>
                        <p>F-37, Kailas Industrial Complex, Building no.1, Near Satara Bank, Veer Savarkar Road, Park Site, Vikhroli (W), Mumbai, 400079</p>
                        <p style="margin-top: -2px;">9029884368</p>
                    </div>
                </div>
                <div>
                    <h3 style="text-align: center; font-size: 30px; margin-top: -35px;">${response.job.status}</h3>
                </div>
                <div class="job-details">
                    <div class="job_left" style="width: 300px;">
                        <p><b>Job Title:</b><span> ${response.job.title}</span></p>
                                        <p><b>Job Reference:</b><span> ${response.job.job_reference_no}</span></p>
                                        <p><b>Name:</b><span> ${response.job.client_name}</span></p>
                                        <p><b>Sales Person:</b><span> ${response.job.contact_person_name} - ${response.job.contact_person_number}</span></p>
                    </div>
                    <div class="job_right" style="width: 200px;">
                        <p><b>Venue:</b><span> ${response.job.venue_name}<br/>${response.job.venue_address}</span></p>
                                        <p><b>Job Date Out:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                                        <p><b>Job Date Back:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                    </div>
                </div>
                <div class="job-details-description">

                    <div style="background-color: #c5d9e1; padding: 10px; margin: 0;">
                <h2 style="margin: 0;">Audio Equipment</h2>
            </div>
                    ${equipmentTableHtml}
                </div>
                <div style="height:30px;" class="color-amount">
                    <p style="text-align: right; color: black; margin-right: 5px; padding-top: 6px;"><b>Total for AUDIO EQUIPMENT INR RS. ${response.total_with_gst}</b></p>
                </div>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
    <tbody>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">Total INR </td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">RS.${response.total_rental_sum}</td>
        </tr>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">After Discount INR</td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">RS.${response.total_after_discount}</td>
        </tr>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">Total Amount with 18% GST INR</td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px;">RS.${response.total_with_gst}</td>
        </tr>
    </tbody>
</table>
            </div>
        </body>
        </html>
    `;

                // Open the print window
                var printWindow = window.open('', '_blank');
                printWindow.document.open();
                printWindow.document.write(printContent);
                printWindow.document.close();

                // Wait for the content to load and then print
                printWindow.onload = function () {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                };
            }

            function handleTotalQuotationPdf(response) {
                var equipmentTableHtml = `
        <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
            <thead>
                <tr>
                    <th style="width: 25%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Equipment Name</th>
                    <th style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Qty</th>
                    <th style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Per Unit</th>
                    <th style="width: 60%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff; font-size: 12px;">Notes</th>
                </tr>
            </thead>
            <tbody>
    `;

                response.equipment_details.forEach(function (detail) {
                    equipmentTableHtml += `
            <tr>
                <td style="width: 25%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${detail.equipment_name}</td>
                <td style="width: 5%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${detail.quantity}</td>
                <td style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${detail.rental_price}</td>
                <td style="width: 60%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #1a1d20; font-size: 12px;">${detail.equipment_notes}</td>
            </tr>
        `;
                });

                equipmentTableHtml += `
            </tbody>
        </table>
    `;

                var printContent = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            .box {
                background-color: #fff;
                padding: 10px;
                margin: 5px auto;
                max-width: 90%;
                min-height: 100%;
            }
            .container {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .left {
                width: 150px;
                text-align: left;
                color: black;
                height: auto;

            }
            .left h4 u {
                color: #0c0c0c;
            }
            .left p {
                margin-bottom: 0px;
            }
            .left p a {
                color: #2881b5;
            }

            .right {
                width: 150px;
                text-align: left;
                margin-top: 30px;
                color: black;
                height: auto;
            }
            .right h4 {
                margin-bottom: 2px;
            }
            .right h4 u {
                color: #0c0c0c;
            }
            .right p {
                margin-bottom: 0px;
            }
            .logo {
                width: 145px;
                align-item: center;
            }
            .job-details {
                display: flex;
                border-top: 1px solid #000000;
                margin-top: -16px;
                padding-top: -5px;
                justify-content: space-between;
                height: auto;
                color: black;
            }
            .job_left {
                display: flex;
                flex-direction: column;
            }
            .job_left p {
                margin-bottom: 0px;
                font-size: 11px;
            }
            .job_left p b {
                display: inline-block;
                width: 110px;
            }
            .job_left p span {
                display: inline-block;
                margin-left: -22px;
            }
            .job_right {
                display: flex;
                flex-direction: column;
                width: 150px; /* Maintain the width */
                word-wrap: break-word; /* Ensures that long text wraps to the next line */
            }
            .job_right p {
                font-size: 11px;
                margin-bottom: 0px;
                display: flex;
                flex-wrap: wrap;
            }
            .job_right p b {
                flex: 0 0 100px; /* Fixed width for the label */
                display: inline-block;
            }
            .job_right p span {
                flex: 1; /* Allows the span to take up remaining space */
                display: inline-block;
                word-wrap: break-word; /* Ensures text inside <span> wraps properly */
            }
            .job-details-description {
                margin-top: 30px;
                border-top: 1px solid #000000;
                display: flex;
                flex-direction: column;
                align-item: left;
                margin-bottom: 20px;
            }
            .job-details-description h4 {
                text-align: left;
                margin-top: 10px;
            }
            .job-details-description h2 {
                text-align: left;
                margin-top: -15px;
            }
            .job_equipment_container {
                display: flex;
                justify-content: space-between;
                margin-top: -10px;
                color: #0c0c0c;
            }
            .job_left_equipment {
                width: 45%;
            }
            .job_right_equipment {
                width: 45%;
                float: right;
                text-align: right;
            }
            .color-amount {
                background-color: #bfcddb;
            }
            .job-container {
                display: flex;
                justify-content: space-between; /* Ensures that h4 and p are spaced apart */
                align-items: center; /* Centers items vertically within the div */
            }
            .job-details-left {
                margin-top: 10px; /* Removes default margin */
            }
            .job-details-center {
                margin: 0; /* Removes default margin */
                text-align: center; /* Centers text inside the paragraph */
                flex: 1; /* Allows the paragraph to take up remaining space */
            }
            #default-text {
                font-size: 20px;
                font-weight: bolder;
                margin-top: auto;
                text-decoration: underline;
            }
            #color {
                background-color: #bfcddb;
                color: #0b0c0f;
                border-bottom: 1px solid #000000;
                font-style: italic;
            }
            .customer-details {
                display: inline-block;
                vertical-align: top;
                max-width: 150px;
            }
            .company-address {
                margin-top: 5px;
                word-wrap: break-word;
            }
            @page {
                size: A4;
                margin: 0;
            }
            body {
                margin: 0px;
                font-size: 10pt;
                padding: 0px;
            }
            @media only screen and (max-width: 500px) {
                .container {
                    flex-direction: column;
                    align-items: center;
                }
                .job-details {
                    width: 100%;
                }
                .job_left,
                .job_right {
                    width: 100%;
                    text-align: center;
                }

            }
        </style>
    </head>
    <body>
        <div class="box">
            <div class="container">
                <div class="left">
                    <h4 style="font-size: 12px; font-weight: bolder; margin-bottom: 2px;"><u>Registered Address:</u></h4>
                    <p style="font-size: 11px; font-weight: bold;">${response.company.company_name}</p>
                    <p style="font-size: 11px;">${response.company.address}</p>
                    <p style="font-size: 11px;><a href="mailto:${response.company.email}" style="background-color: black; color: #2881b5;">${response.company.email}</a></p>
                    <p style="font-size: 11px; font-weight: bold;">GST No: ${response.company.gst_no}</p>
                </div>
                <div class="logo">
                    <img id="logoImage" src="${response.company.company_logo}" class="logo" alt="Logo" />
                </div>
                <div class="right">
                    <h4 style="font-size: 12px; font-weight: bolder; margin-bottom: 2px;"><u>Warehouse Address:</u></h4>
                    <p style="font-size: 11px; font-weight: bold;">Echoes</p>
                    <p style="font-size: 11px;">F-37, Kailas Industrial Complex, Building no.1, Near Satara Bank, Veer Savarkar Road, Park Site, Vikhroli (W), Mumbai, 400079</p>
                    <p style="font-size: 11px;">9029884368</p>
                </div>
            </div>
            <div>
                <h3 style="text-align: center; font-size: 30px; margin-top: -35px; color: #0b0c0f;">${response.job.status}</h3>
            </div>
            <div class="job-details">
                <div class="job_left" style="width: 400px;">
                    <p><b>Job Title:</b><span> ${response.job.title}</span></p>
                    <p><b>Job Ref:</b><span> ${response.job.job_reference_no}</span></p>

                    <p><b>No of Days:</b><span> ${response.job.total_days}</span></p>
                    <p><b>Customer:</b><span> ${response.job.client_name}</span></p>
                    <p><b>Sales Person:</b><span> ${response.job.contact_person_name} - ${response.job.contact_person_number}</span></p>
                </div>
                <div class="job_right" style="width: 200px;">
                    <p><b>Venue:</b><span> ${response.job.venue_name}<br/>${response.job.venue_address}</span></p>
                    <p><b>Job Date Out:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                    <p><b>Job Date Back:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                </div>
            </div>

            <div class="job-details-description">
                <div class="job-container">
                    </div>
                    <h2 id="color" style="font-size: 14px; font-weight: bolder">AUDIO EQUIPMENT</h2>
                        ${equipmentTableHtml}
                </div>
                <div style="height:30px;" class="color-amount">
                    <p style="text-align: right; color: black; margin-right: 5px;"><b>Total for AUDIO EQUIPMENT INR RS. ${response.total_with_gst}</b></p>
                </div>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
    <tbody>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%; color: #050505;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: #050505;">Total INR </td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: #050505;">RS.${response.total_rental_sum}</td>
        </tr>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%; color: #050505;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: #050505;">After Discount INR</td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: #050505;">RS.${response.total_after_discount}</td>
        </tr>
        <tr>
<td style="text-align: right; border: 1px solid #ddd; padding: 8px; width: 55%; color: #050505;"></td> <!-- New Column -->
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: #050505;">Total Amount with 18% GST INR</td>
            <td style="text-align: right; border: 1px solid #ddd; padding: 8px; color: #050505;">RS.${response.total_with_gst}</td>
        </tr>
    </tbody>
</table>
            </div>
    </body>
    </html>
    `;
                // Convert the HTML to a PDF and download it
                var img = new Image();
                img.src = response.company.company_logo;
                img.onload = function() {
                    // Convert the HTML to a PDF and download it after the image is loaded
                    var opt = {
                        margin: 0,
                        filename: 'Total Quotation.pdf',
                        image: {type: 'jpeg', quality: 0.98},
                        html2canvas: {scale: 2, useCORS: true},
                        jsPDF: {unit: 'in', format: 'letter', orientation: 'portrait'}
                    };

                    html2pdf().from(printContent).set(opt).save();
                };
            }

            function handlePerfoma(response) {
                // Construct the PDF content dynamically for "quotation" status
                var equipmentLeftHtml = '';
                var equipmentRightHtml = '';

                response.equipment_details.forEach(function (detail) {
                    equipmentLeftHtml += `<p>${detail.quantity}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${detail.equipment_name}</p>`;
                    equipmentRightHtml += `<p>RS. ${detail.rental_price}</p>`;
                });

                var printContent = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                .box {
                    background-color: #fff;
                    padding: 20px;
                    margin: 10px auto;
                    max-width: 700px;
                    min-height: 100%;
                }
                .container {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 0px;
                }
                .left {
                    width: 150px;
                    text-align: left;
                }
                .right {
                    width: 150px;
                    text-align: right;
                    padding-top: 5px;
                    margin-top: -60px;
                }
                .left p {
                    margin-bottom: 4px;
                }
                .left h3 {
                    margin-bottom: -10px;
                }
                .left h5 {
                    margin-top: 5px;
                }
                .logo {
                    width: 100px;
                    align-item: center;
                }
                .job-details {
                    display: flex;
                    border-top: 1px solid #000000;
                    padding-top: -10px;
                    justify-content: space-between;
                    height: auto;
                }
                .job_left {
                    display: flex;
                    flex-direction: column;
                }
                .job_left p {
                    margin-bottom: -5px;
                }
                .job_left p b {
                    display: inline-block;
                    width: 120px;
                }
                .job_left p span {
                    display: inline-block;
                    margin-left: -22px;
                }
                .job_right {
                    width: 250px;
                    display: inline-block;
                    vertical-align: top;
                }
                .job-details-description {
                    margin-top: 15px;
                    border-top: 1px solid #000000;
                    display: flex;
                    flex-direction: column;
                    align-item: left;
                    margin-bottom: 20px;
                }
                .job-details-description h4 {
                    text-align: left;
                }
                .job-details-description h2 {
                    text-align: left;
                    margin-top: -15px;
                }
                .job_equipment_container {
                    display: flex;
                    justify-content: space-between;
                    margin-top: -10px;
                }
                .job_left_equipment {
                    width: 45%;
                }
                .job_right_equipment {
                    width: 45%;
                    float: right;
                    text-align: right;
                }
                .color-amount{
                    background-color: #00aced;
                }
                @page {
                    size: A4;
                    margin: 0;
                }
                body {
                    margin: 0;
                    font-size: 10pt;
                    background-color: black;
                }
                @media only screen and (max-width: 300px) {
                    .container {
                        flex-direction: column;
                        align-items: center;
                    }
                    .job-details {
                        width: 100%;
                    }
                    .job_left,
                    .job_right {
                        width: 100%;
                        text-align: center;
                    }
                }
            </style>
        </head>
        <body>
            <div class="box">
                <div class="container">
                    <div class="left">
                        <h3><u>Registered Address:</u></h3>
                        <h3 style="font-size: 14px;">${response.job.company_name}</h3>
                        <p>${response.job.company_address}</p>
                        <p><a href="mailto:${response.job.company_email}">${response.job.company_email}</a></p>
                        <h5>GST No: ${response.job.company_gst_no}</h5>
                    </div>
                    <div class="logo">
                        <img id="logoImage" src="${response.job.company_logo_path}" class="logo" alt="Logo" />
                    </div>
                    <div class="right">
                        <h3><u>Warehouse Address:</u></h3>
                        <h3 style="font-size: 14px;">Echoes</h3>
                        <p>F-37, Kailas Industrial Complex, Building no.1, Near Satara Bank, Veer Savarkar Road, Park Site, Vikhroli (W), Mumbai, 400079</p>
                        <p>9029884368</p>
                    </div>
                </div>
                <div>
                    <h3 style="text-align: center; font-size: 30px; margin-top: -35px;">${response.job.status}</h3>
                </div>
                <div class="job-details">
                    <div class="job_left" style="width: 300px;">
                        <p><b>Job Title:</b><span> ${response.job.title}</span></p>
                        <p><b>Job Reference:</b><span> ${response.job.job_reference_no}</span></p>
                        <p><b>Job Date Out:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                        <p><b>Job Date Back:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                        <p><b>Customer:</b><span> Xplused Events Pvt.Ltd</span></p>
                    </div>
                    <div class="job_right" style="text-align: right; width: 250px;">
                        <p><b>Venue:</b><span> ${response.job.venue_address}</span></p>
                        <p><b>Sales Person:</b><span> ${response.job.contact_person_name}</span></p>
                    </div>
                </div>
                <div class="job-details-description">
                    <h4>Qty Description</h4>
                    <h2>Audio Equipment</h2>
                    <div class="job_equipment_container">
                        <div class="job_left_equipment">
                            ${equipmentLeftHtml}
                        </div>
                        <div class="job_right_equipment">
                            ${equipmentRightHtml}
                        </div>
                    </div>
                </div>
                <div style="height:30px;" class="color-amount">
                    <p style="text-align: right; color: black;"><b>Total for AUDIO EQUIPMENT RS. ${response.job.amount_row}</b></p>
                </div>
                <div>
                    <p style="text-align: right;">Total RS. ${response.job.amount_row}</p>
                </div>
                <div style="text-align: center; font-size: 22px;">
                    <b><u>Warehouse Added Equipment</u></b>
                </div>
                <p style="font-size: 18px;"><i><b>AUDIO EQUIPMENT</i></b></p>
                <div style="display: flex; justify-content: space-between;">
                    <p style="text-align: left;">2 MACKIE SRM150</p>
                    <p style="text-align: right;">RS. 0,00</p>
                </div>
            </div>
        </body>
        </html>
    `;

                // Open the print window
                var printWindow = window.open('', '_blank');
                printWindow.document.open();
                printWindow.document.write(printContent);
                printWindow.document.close();

                // Print the window
                var logoImage = printWindow.document.getElementById('logoImage');
                logoImage.onload = function () {
                    printWindow.focus();
                    printWindow.print();
                };
            }

            function handlePrepsheet(response) {
                var equipmentTableHtml = `
        <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
            <thead>
                <tr>
                    <th style="width: 40%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Equipment Name</th>
                    <th style="width: 20%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Quantity</th>
                    <th style="width: 40%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Notes</th>
                </tr>
            </thead>
            <tbody>
    `;

                response.equipment_details.forEach(function (detail) {
                    equipmentTableHtml += `
            <tr>
                <td style="width: 40%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${detail.equipment_name}</td>
                <td style="width: 20%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${detail.quantity}</td>
                <td style="width: 40%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${detail.equipment_notes}</td>
            </tr>
        `;
                });

                equipmentTableHtml += `
            </tbody>
        </table>
    `;

                var printContent = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            .box {
                background-color: #fff;
                padding: 20px;
                margin: 10px auto;
                max-width: 700px;
                min-height: 100%;
            }
            .container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0px;
            }
            .left {
                width: 150px;
                text-align: left;
            }
            .right {
                width: 150px;
                text-align: left;
            }
            .right p {
                margin-bottom: 4px;
            }
            .right h3 {
                margin-bottom: -10px;
            }
            .right h5 {
                margin-top: 5px;
            }
            .left p {
                margin-bottom: 4px;
            }
            .left h3 {
                margin-bottom: -10px;
            }
            .left h5 {
                margin-top: 5px;
            }
            .logo {
                width: 145px;
                align-item: center;
            }
            .job-details {
                display: flex;
                border-top: 1px solid #000000;
                margin-top: -22px;
                padding-top: -10px;
                justify-content: space-between;
                height: auto;
            }
            .equipment-details {
                display: flex;
                border-top: 10px solid #d1e0d3;
                margin-top: 20px;
                padding-top: 10px;
                justify-content: space-between;
                height: auto;
            }

            .equipment_left {
                display: flex;
                flex-direction: column;
                margin-top: -15px;
            }

            .equipment_left p {
                margin-bottom: -8px; /* Adjusted margin for better spacing */
            }

            .equipment_left p b {
                display: inline-block;
                width: 100px; /* Fixed width for labels to align values */
            }

            .equipment_left p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
            .equipment_right {
                display: flex;
                flex-direction: column;
                margin-top: -15px;
            }

            .equipment_right p {
                margin-bottom: -8px; /* Adjusted margin for better spacing */
            }

            .equipment_right p b {
                display: inline-block;
                width: 100px; /* Fixed width for labels to align values */
            }

            .equipment_right p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
            .job_left {
                display: flex;
                flex-direction: column;
            }
            .job_left p {
                margin-bottom: -12px;
            }
            .job_left p b {
                display: inline-block;
                width: 110px;
            }
            .job_left p span {
                display: inline-block;
                margin-left: -22px;
            }
            .job_right {
    display: flex;
    flex-direction: column;
    width: 150px; /* Maintain the width */
    word-wrap: break-word; /* Ensures that long text wraps to the next line */
}

.job_right p {
    margin-bottom: -5px;
    display: flex;
    flex-wrap: wrap;
}

.job_right p b {
    flex: 0 0 100px; /* Fixed width for the label */
    display: inline-block;
}

.job_right p span {
    flex: 1; /* Allows the span to take up remaining space */
    display: inline-block;
    word-wrap: break-word; /* Ensures text inside <span> wraps properly */
}
            .job-details-description {
                margin-top: 30px;
                border-top: 1px solid #000000;
                display: flex;
                flex-direction: column;
                align-item: left;
                margin-bottom: 20px;
            }
            .job-details-description h4 {
                text-align: left;
                margin-top: 10px;
            }
            .job-details-description h2 {
                text-align: left;
                margin-top: -15px;
            }
            .job_equipment_container {
                display: flex;
                justify-content: space-between;
                margin-top: -10px;
            }
            .job_left_equipment {
                width: 45%;
            }
            .job_right_equipment {
                width: 45%;
                float: right;
                text-align: right;
            }
            .color-amount {
                background-color: #00aced;
            }
            .job-container {
                display: flex;
                justify-content: space-between; /* Ensures that h4 and p are spaced apart */
                align-items: center; /* Centers items vertically within the div */
            }
            .job-details-left {
                margin-top: 10px; /* Removes default margin */
            }
            .job-details-center {
                margin: 0; /* Removes default margin */
                text-align: center; /* Centers text inside the paragraph */
                flex: 1; /* Allows the paragraph to take up remaining space */
            }
            #default-text {
                font-size: 20px;
                font-weight: bolder;
                margin-top: auto;
                text-decoration: underline;
            }
            #color {
                background-color: #bfcddb;
                color: #0b0c0f;
                border-bottom: 1px solid #000000;
                font-style: italic;
            }
            .customer-details {
                display: inline-block;
                vertical-align: top;
                max-width: 150px;
            }
            .company-address {
                margin-top: 5px;
                word-wrap: break-word;
            }
            @page {
                size: A4;
                margin: 0;
            }
            body {
                margin: 0px;
                font-size: 10pt;
                background-color: #FFFFFF;
                padding: 0px;
            }
            @media only screen and (max-width: 500px) {
                .container {
                    flex-direction: column;
                    align-items: center;
                }
                .job-details {
                    width: 100%;
                }
                .job_left,
                .job_right {
                    width: 100%;
                    text-align: center;
                }

            }
        </style>
    </head>
    <body>
        <div class="box">
            <div class="container">
                <div class="left">
                    <h3><u><i>Registered Address:</i></u></h3>
                    <h3 style="font-size: 14px;">${response.company.company_name}</h3>
                    <p>${response.company.address}</p>
                    <p style="margin-top: -4px;"><a href="mailto:${response.company.email}">${response.company.email}</a></p>
                    <h5 style="font-size: 11px;">GST No: ${response.company.gst_no}</h5>
                </div>
                <div class="logo">
                    <img id="logoImage" src="${response.company.company_logo}" class="logo" alt="Logo" />
                </div>
                <div class="right">
                    <h3><u>Warehouse Address:</u></h3>
                    <h3 style="font-size: 14px;">Echoes</h3>
                    <p>F-37, Kailas Industrial Complex, Building no.1, Near Satara Bank, Veer Savarkar Road, Park Site, Vikhroli (W), Mumbai, 400079</p>
                    <p style="margin-top: -2px;">9029884368</p>
                </div>
            </div>
            <div>
                <h3 style="text-align: center; font-size: 30px; margin-top: -35px;">${response.job.status}</h3>
            </div>
            <div class="job-details">
                <div class="job_left" style="width: 400px;">
                    <p><b>Job Title:</b><span> ${response.job.title}</span></p>
                    <p><b>Job Ref:</b><span> ${response.job.job_reference_no}</span></p>
                    <p><b>Client:</b><span class="customer-details"> ${response.job.client_name}<br>${response.job.address}<br>
                    ${response.job.state}<br>${response.job.post_code}<br>${response.job.country}</span></p>
                </div>
                <div class="job_right" style="width: 200px;">
                    <p><b>Venue:</b><span> ${response.job.venue_name}<br/>${response.job.venue_address}</span></p>
                    <p><b>Sound Engineer:</b><span> ${response.job.contact_person_name}</span></p>
                    <p><b>Client Contact:</b><span> ${response.job.contact_person_number}</span></p>
                </div>
            </div>
            <div class="equipment-details">
                <div class="equipment_left" style="width: 700px;">
                    <p><b>Equipment Title:</b><span> ${response.job.title}</span>:<span>${response.job.job_reference_no}</span></p>
                    <p><b>Equipment Ref:</b><span> ${response.job.job_reference_no}</span></p>
                    <p><b>Event Start Date:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                    <p><b>Event End Date:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                </div>
            </div>
            <div class="job-details-description">
            <div class="job-container">

                </div>
                <h2 id="color">AUDIO EQUIPMENT</h2>

                        ${equipmentTableHtml}

            </div>
        </div>
    </body>
    </html>
    `;
                // Open the print window
                var printWindow = window.open('', '_blank');
                printWindow.document.open();
                printWindow.document.write(printContent);
                printWindow.document.close();

                // Wait for the content to load and then print
                printWindow.onload = function () {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                };
            }

            function handleDeliveryChallan(response) {

                let equipmentDetailsHtml = "";
    let processedIds = new Set();

    response.equipment_details.forEach(function(detail) {
        if (!processedIds.has(detail.equipment_detail_id)) {
            processedIds.add(detail.equipment_detail_id);

            // Generate equipment details HTML for each unique equipment_detail_id
            let equipmentTableHtml = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                    <thead>
                        <tr>
                            <th style="width: 40%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Equipment Name</th>
                            <th style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Quantity</th>
                            <th style="width: 48%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Loop through and add only rows matching this equipment_detail_id
            response.equipment_details
                .filter(item => item.equipment_detail_id === detail.equipment_detail_id)
                .forEach(function(item) {
                    equipmentTableHtml += `
                        <tr>
                            <td style="width: 40%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${item.equipment_name}</td>
                            <td style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${item.quantity}</td>
                            <td style="width: 48%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left;">${item.equipment_notes || '-'}</td>
                        </tr>
                    `;
                });

            equipmentTableHtml += `
                    </tbody>
                </table>
            `;

            equipmentDetailsHtml += `
                <div class="equipment-details">
                    <div class="equipment_left" style="width: 700px;">
                        <p><b>Equipment Title:</b><span> ${response.job.title}</span>:<span>${detail.equipment_detail_id}</span></p>
                        <p><b>Equipment Ref:</b><span> ${detail.equipment_detail_id}</span></p>
                        <p><b>Location:</b><span> ${detail.location}</span></p>
                        <p><b>Event Start Date:</b><span> ${detail.equipment_setup_date}</span></p>
                        <p><b>Event End Date:</b><span> ${detail.equipment_rehearsal_date}</span></p>
                    </div>
                    <div class="equipment_right" style="width: 300px;">
                        <p><b>Show Start Date:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                        <p><b>Setup Date:</b><span> ${response.job.setup_date}</span></p>
                        <p><b>Show End Date:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                        <p><b>Pack Up Date:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                    </div>

                </div>
<div class="job-details-description">
            <div class="job-container">

                </div>
                <h2 id="color" style="margin-top: 10px;">AUDIO EQUIPMENT</h2>

                        ${equipmentTableHtml}

            </div>
            `;
        }
    });


                var printContent = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            .box {
                background-color: #fff;
                padding: 20px;
                margin: -35px auto;
                max-width: 95%;
                min-height: 90%;
            }
            .container {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .left {
                width: 150px;
                text-align: left;
            }
            .right {
                width: 150px;
                text-align: left;
            }
            .right p {
                margin-bottom: 4px;
            }
            .right h3 {
                margin-bottom: -10px;
            }
            .right h5 {
                margin-top: 5px;
            }
            .left p {
                margin-bottom: 4px;
            }
            .left h3 {
                margin-bottom: -10px;
            }
            .left h5 {
                margin-top: 5px;
            }
            .logo {
                width: 145px;
                align-item: center;
            }
            .job-details {
                display: flex;
                border-top: 1px solid #000000;
                margin-top: -22px;
                padding-top: -10px;
                justify-content: space-between;
                height: auto;
            }
            .equipment-details {
                display: flex;
                border-top: 10px solid #d1e0d3;
                margin-top: 20px;
                padding-top: 10px;
                justify-content: space-between;
                height: auto;
            }

            .equipment_left {
                display: flex;
                flex-direction: column;
                margin-top: -15px;
            }

            .equipment_left p {
                margin-bottom: -8px; /* Adjusted margin for better spacing */
            }

            .equipment_left p b {
                display: inline-block;
                width: 100px; /* Fixed width for labels to align values */
            }

            .equipment_left p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
            .equipment_right {
                display: flex;
                flex-direction: column;
                margin-top: -15px;
            }

            .equipment_right p {
                margin-bottom: -8px; /* Adjusted margin for better spacing */
            }

            .equipment_right p b {
                display: inline-block;
                width: 100px; /* Fixed width for labels to align values */
            }

            .equipment_right p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
            .job_left {
                display: flex;
                flex-direction: column;
            }
            .job_left p {
                margin-bottom: -12px;
            }
            .job_left p b {
                display: inline-block;
                width: 110px;
            }
            .job_left p span {
                display: inline-block;
                margin-left: -22px;
            }
            .job_right {
    display: flex;
    flex-direction: column;
    width: 150px; /* Maintain the width */
    word-wrap: break-word; /* Ensures that long text wraps to the next line */
}

.job_right p {
    margin-bottom: -5px;
    display: flex;
    flex-wrap: wrap;
}

.job_right p b {
    flex: 0 0 100px; /* Fixed width for the label */
    display: inline-block;
}

.job_right p span {
    flex: 1; /* Allows the span to take up remaining space */
    display: inline-block;
    word-wrap: break-word; /* Ensures text inside <span> wraps properly */
}
            .job-details-description {
                margin-top: 30px;
                border-top: 1px solid #000000;
                display: flex;
                flex-direction: column;
                align-item: left;
                margin-bottom: 20px;
            }
            .job-details-description h4 {
                text-align: left;
                margin-top: 10px;
            }
            .job-details-description h2 {
                text-align: left;
                margin-top: -15px;
            }
            .job_equipment_container {
                display: flex;
                justify-content: space-between;
                margin-top: -10px;
            }
            .job_left_equipment {
                width: 45%;
            }
            .job_right_equipment {
                width: 45%;
                float: right;
                text-align: right;
            }
            .color-amount {
                background-color: #00aced;
            }
            .job-container {
                display: flex;
                justify-content: space-between; /* Ensures that h4 and p are spaced apart */
                align-items: center; /* Centers items vertically within the div */
            }
            .job-details-left {
                margin-top: 10px; /* Removes default margin */
            }
            .job-details-center {
                margin: 0; /* Removes default margin */
                text-align: center; /* Centers text inside the paragraph */
                flex: 1; /* Allows the paragraph to take up remaining space */
            }
            #default-text {
                font-size: 20px;
                font-weight: bolder;
                margin-top: auto;
                text-decoration: underline;
            }
            #color {
                background-color: #bfcddb;
                color: #0b0c0f;
                border-bottom: 1px solid #000000;
                font-style: italic;
            }
            .customer-details {
                display: inline-block;
                vertical-align: top;
                max-width: 150px;
            }
            .company-address {
                margin-top: 5px;
                word-wrap: break-word;
            }
            @page {
                size: A4;
                margin: 0;
            }
            body {
                margin: 0;
                font-size: 10pt;
                background-color: #FFFFFF;
                padding: 0;
            }

            @media only screen and (max-width: 500px) {
                .container {
                    flex-direction: column;
                    align-items: center;
                }
                .job-details {
                    width: 100%;
                }
                .job_left,
                .job_right {
                    width: 100%;
                    text-align: center;
                }


            }
@page {
    size: A4;
    margin: 0.5cm;
}

body {
    margin: 0;
    font-size: 10pt;
    background-color: #FFFFFF;
    padding: 1cm; }

.table-container {
    page-break-inside: avoid;
}

.equipment-details,
.job-details,
.job-details-description {
    page-break-inside: avoid; }

        </style>
    </head>
    <body>
    <div class="box">

            <div class="container">
                <div class="left">
                    <h3><u><i>Registered Address:</i></u></h3>
                    <h3 style="font-size: 14px;">${response.company.company_name}</h3>
                    <p>${response.company.address}</p>
                    <p style="margin-top: -4px;"><a href="mailto:${response.company.email}">${response.company.email}</a></p>
                    <h5 style="font-size: 11px;">GST No: ${response.company.gst_no}</h5>
                </div>
                <div class="logo">
                    <img id="logoImage" src="${response.company.company_logo}" class="logo" alt="Logo" />
                </div>
                <div class="right">
                    <h3><u>Warehouse Address:</u></h3>
                    <h3 style="font-size: 14px;">Echoes</h3>
                    <p>F-37, Kailas Industrial Complex, Building no.1, Near Satara Bank, Veer Savarkar Road, Park Site, Vikhroli (W), Mumbai, 400079</p>
                    <p style="margin-top: -2px;">9029884368</p>
                </div>
            </div>
            <div>
                <h3 style="text-align: center; font-size: 30px; margin-top: -15px;">${response.job.status}</h3>
            </div>

            <div class="job-details">
                <div class="job_left" style="width: 400px;">
                    <p><b>Job Title:</b><span> ${response.job.title}</span></p>
                    <p><b>Job Ref:</b><span> ${response.job.job_reference_no}</span></p>
                    <p><b>Client:</b><span class="customer-details"> ${response.job.client_name}<br>${response.job.address}<br>
                    ${response.job.state}<br>${response.job.post_code}<br>${response.job.country}</span></p>
                </div>
                <div class="job_right" style="width: 200px;">
                    <p><b>Venue:</b><span> ${response.job.venue_name}<br/>${response.job.venue_address}</span></p>
                    <p><b>Sound Engineer:</b><span> ${response.job.contact_person_name}</span></p>
                    <p><b>Client Contact:</b><span> ${response.job.contact_person_number}</span></p>
                </div>
            </div>
            ${equipmentDetailsHtml} <!-- Include equipment details here -->
        </div>

</body>

    </html>
    `;
                // Open the print window
                var printWindow = window.open('', '_blank');
                printWindow.document.open();
                printWindow.document.write(printContent);
                printWindow.document.close();

                // Wait for the content to load and then print
                printWindow.onload = function () {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                };
            }

            function handleDeliveryChallanPdf(response) {
                let equipmentDetailsHtml = "";
    let processedIds = new Set();

    response.equipment_details.forEach(function(detail) {
        if (!processedIds.has(detail.equipment_detail_id)) {
            processedIds.add(detail.equipment_detail_id);

            // Generate equipment details HTML for each unique equipment_detail_id
            let equipmentTableHtml = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                    <thead>
                        <tr>
                            <th style="width: 40%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff;">Equipment Name</th>
                            <th style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff;">Quantity</th>
                            <th style="width: 48%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0d0c0c; background-color: #ffffff;">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Loop through and add only rows matching this equipment_detail_id
            response.equipment_details
                .filter(item => item.equipment_detail_id === detail.equipment_detail_id)
                .forEach(function(item) {
                    equipmentTableHtml += `
                        <tr>
                            <td style="width: 40%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0f0f0f;">${item.equipment_name}</td>
                            <td style="width: 10%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0f0f0f;">${item.quantity}</td>
                            <td style="width: 48%; border: 1px solid #ddd; padding: 4px 4px 4px 10px; text-align: left; color: #0f0f0f;">${item.equipment_notes || '-'}</td>
                        </tr>
                    `;
                });

            equipmentTableHtml += `
                    </tbody>
                </table>
            `;

            equipmentDetailsHtml += `
                <div class="equipment-details">
                    <div class="equipment_left" style="width: 700px;">
                        <p><b>Equipment Title:</b><span> ${response.job.title}</span>:<span>${detail.equipment_detail_id}</span></p>
                        <p><b>Equipment Ref:</b><span> ${detail.equipment_detail_id}</span></p>
                        <p><b>Location:</b><span> ${detail.location}</span></p>
                        <p><b>Event Start Date:</b><span> ${detail.equipment_setup_date}</span></p>
                        <p><b>Event End Date:</b><span> ${detail.equipment_rehearsal_date}</span></p>
                    </div>
                    <div class="equipment_right" style="width: 300px;">
                        <p><b>Show Start Date:</b><span> ${response.job.event_date ? response.job.event_date : '-'}</span></p>
                        <p><b>Setup Date:</b><span> ${response.job.setup_date}</span></p>
                        <p><b>Show End Date:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                        <p><b>Pack Up Date:</b><span> ${response.job.dismantle_date ? response.job.dismantle_date : '-'}</span></p>
                    </div>

                </div>
<div class="job-details-description">
            <div class="job-container">

                </div>
                <h3 id="color" style="margin-top: 10px;">AUDIO EQUIPMENT</h3>

                        ${equipmentTableHtml}

            </div>
            `;
        }
    });

                var printContent = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            .box {
                background-color: #fff;
                padding: 10px;
                margin: 5px auto;
                max-width: 90%;
                min-height: 100%;
            }
            .container {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .left {
                width: 150px;
                text-align: left;
                color: black;
                height: auto;

            }
            .left h4 u {
                color: #0c0c0c;
            }
            .left p {
                margin-bottom: 0;
            }
            .left p a {
                color: #2881b5;
            }
            .right {
                width: 150px;
                text-align: left;
                margin-top: 30px;
                color: black;
                height: auto;
            }
            .right h4 {
                margin-bottom: 2px;
             }
            .right h4 u {
                color: #0c0c0c;
            }
            .right p {
                margin-bottom: 0;
            }
            .logo {
                width: 145px;
                align-item: center;
            }
            .job-details {
                display: flex;
                border-top: 5px solid #000000;
                margin-top: -16px;
                padding-top: -5px;
                justify-content: space-between;
                height: auto;
                color: black;
            }
            .equipment-details {
                display: flex;
                border-top: 8px solid #d1e0d3;
                margin-top: 20px;
                padding-top: 10px;
                justify-content: space-between;
                height: auto;
                font-size: 12px;
            }

            .equipment_left {
                display: flex;
                flex-direction: column;
                margin-top: -2px;
                justify-content: space-between;
                color: #1a1d20;

            }

            .equipment_left p {
                margin-bottom: 0; /* Adjusted margin for better spacing */
            }

            .equipment_left p b {
                display: inline-block;
                width: 110px; /* Fixed width for labels to align values */
            }
            .equipment_left b{
                font-size: 12px;
                color: #0c0c0c;
            }

            .equipment_left p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
            .equipment_right {
                display: flex;
                flex-direction: column;
                margin-top: -2px;
                justify-content: space-between;
                color: #1a1d20;
            }

            .equipment_right p {
                margin-bottom: 0; /* Adjusted margin for better spacing */
            }

            .equipment_right p b {
                display: inline-block;
                width: 110px; /* Fixed width for labels to align values */
            }

            .equipment_right p span {
                display: inline-block;
                margin-left: 5px; /* Space between label and value */
                text-align: left; /* Align values to the left */
            }
            .equipment_right b{
                font-size: 12px;
                color: #0c0c0c;
            }
            .job_left {
                display: flex;
                flex-direction: column;
            }
            .job_left p {
                margin-bottom: 0;
                font-size: 11px;
            }
            .job_left p b {
                display: inline-block;
                width: 110px;
            }
            .job_left p span {
                display: inline-block;
                margin-left: -22px;
            }
            .job_right {
                display: flex;
                flex-direction: column;
                width: 150px; /* Maintain the width */
                word-wrap: break-word; /* Ensures that long text wraps to the next line */
            }
            .job_right p {
                font-size: 11px;
                margin-bottom: 0;
                display: flex;
                flex-wrap: wrap;
            }
            .job_right p b {
                flex: 0 0 100px; /* Fixed width for the label */
                display: inline-block;
            }
            .job_right p span {
                flex: 1; /* Allows the span to take up remaining space */
                display: inline-block;
                word-wrap: break-word; /* Ensures text inside <span> wraps properly */
            }
            .job-details-description {
                margin-top: 30px;
                border-top: 1px solid #000000;
                display: flex;
                flex-direction: column;
                align-item: left;
                margin-bottom: 20px;
            }
            .job-details-description h4 {
                text-align: left;
                margin-top: 10px;
            }
            .job-details-description h2 {
                text-align: left;
                margin-top: -15px;
            }
            .job_equipment_container {
                display: flex;
                justify-content: space-between;
                margin-top: -10px;
                color: #0c0c0c;
            }
            .job_left_equipment {
                width: 45%;
            }
            .job_right_equipment {
                width: 45%;
                float: right;
                text-align: right;
            }
            .color-amount {
                background-color: #bfcddb;
            }
            .job-container {
                display: flex;
                justify-content: space-between; /* Ensures that h4 and p are spaced apart */
                align-items: center; /* Centers items vertically within the div */
            }
            .job-details-left {
                margin-top: 10px; /* Removes default margin */
            }
            .job-details-center {
                margin: 0; /* Removes default margin */
                text-align: center; /* Centers text inside the paragraph */
                flex: 1; /* Allows the paragraph to take up remaining space */
            }
            #default-text {
                font-size: 20px;
                font-weight: bolder;
                margin-top: auto;
                text-decoration: underline;
            }
            #color {
                background-color: #bfcddb;
                color: #0b0c0f;
                border-bottom: 1px solid #000000;
                font-style: italic;
            }
            .customer-details {
                display: inline-block;
                vertical-align: top;
                max-width: 150px;
            }
            .company-address {
                margin-top: 5px;
                word-wrap: break-word;
            }
            @page {
                size: A4;
                margin: 0;
            }
            body {
                margin: 0;
                font-size: 10pt;
                padding: 0;
            }
            @media only screen and (max-width: 500px) {
                .container {
                    flex-direction: column;
                    align-items: center;
                }
                .job-details {
                    width: 100%;
                }
                .job_left,
                .job_right {
                    width: 100%;
                    text-align: center;
                }

            }
        </style>
    </head>
    <body>
        <div class="box">
            <div class="container">
                <div class="left">
                    <h4 style="font-size: 12px; font-weight: bolder; margin-bottom: 2px;"><u>Registered Address:</u></h4>
                    <p style="font-size: 11px; font-weight: bold;">${response.company.company_name}</p>
                    <p style="font-size: 11px;">${response.company.address}</p>
                    <p style="font-size: 11px;><a href="mailto:${response.company.email}" style="background-color: black; color: #2881b5;">${response.company.email}</a></p>
                    <p style="font-size: 11px; font-weight: bold;">GST No: ${response.company.gst_no}</p>
                </div>
                <div class="logo">
                    <img id="logoImage" src="${response.company.company_logo}" class="logo" alt="${response.company.company_name} Logo" />
                </div>
                <div class="right">
                    <h4 style="font-size: 12px; font-weight: bolder; margin-bottom: 2px;"><u>Warehouse Address:</u></h4>
                    <p style="font-size: 11px; font-weight: bold;">Echoes</p>
                    <p style="font-size: 11px;">F-37, Kailas Industrial Complex, Building no.1, Near Satara Bank, Veer Savarkar Road, Park Site, Vikhroli (W), Mumbai, 400079</p>
                    <p style="font-size: 11px;">9029884368</p>
                </div>
            </div>
            <div>
                <p style="text-align: center; font-size: 30px; margin-top: -35px; color: #0b0c0f;">${response.job.status}</p>
            </div>
            <div class="job-details">
                <div class="job_left" style="width: 400px;">
                    <p><b>Job Title:</b><span> ${response.job.title}</span></p>
                    <p><b>Job Ref:</b><span> ${response.job.job_reference_no}</span></p>
                    <p><b>Client:</b><span class="customer-details"> ${response.job.client_name}<br>${response.job.address}<br>
                    ${response.job.state}<br>${response.job.post_code}<br>${response.job.country}</span></p>
                </div>
                <div class="job_right" style="width: 200px;">
                    <p><b>Venue:</b><span> ${response.job.venue_name}<br/>${response.job.venue_address}</span></p>
                    <p><b>Sound Engineer:</b><span> ${response.job.contact_person_name}</span></p>
                    <p><b>Client Contact:</b><span> ${response.job.contact_person_number}</span></p>
                </div>
            </div>

            ${equipmentDetailsHtml} <!-- Include equipment details here -->
        </div>
    </body>
    </html>
    `;
                // Convert the HTML to a PDF and download it
                var img = new Image();
                img.src = response.company.company_logo;
                img.onload = function() {
                    // Convert the HTML to a PDF and download it after the image is loaded
                    var opt = {
                        margin: 0,
                        filename: 'Delivery Challan.pdf',
                        image: {type: 'jpeg', quality: 0.98},
                        html2canvas: {scale: 2, useCORS: true},
                        jsPDF: {unit: 'in', format: 'letter', orientation: 'portrait'}
                    };

                    html2pdf().from(printContent).set(opt).save();
                };
            }
        });
    </script>
    <body>
    <!--*******************
        Preloader start
    ********************-->
    <div id="preloader">
        <div class="lds-ripple">
            <div></div>
            <div></div>
        </div>
    </div>
    <!--*******************
        Preloader end
    ********************-->

    <!--**********************************
        Main wrapper start
    ***********************************-->
    <div id="main-wrapper">
        <!--**********************************
            Nav header start
        ***********************************-->
        {% include 'product_tracking/navheader.html' %}
        <!--**********************************
            Nav header end
        ***********************************-->

        <!--**********************************
                    Header start
        ***********************************-->
        {% include 'product_tracking/header.html' %}
        <!--**********************************
                    Header end
        ***********************************-->

        <!--**********************************
            Sidebar start
        ***********************************-->
        {% include 'product_tracking/sidebar.html' %}
        <!--**********************************
            Sidebar end
        ***********************************-->

        <!--**********************************
            Content body start
        ***********************************-->

        <div class="content-body">
            <div class="page-titles">
                <ol class="breadcrumb">
                    <li><h5 class="bc-title">Order book</h5></li>
                    <li class="breadcrumb-item"><a href="javascript:void(0)">
                        <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.125 6.375L8.5 1.41667L14.875 6.375V14.1667C14.875 14.5424 14.7257 14.9027 14.4601 15.1684C14.1944 15.4341 13.8341 15.5833 13.4583 15.5833H3.54167C3.16594 15.5833 2.80561 15.4341 2.53993 15.1684C2.27426 14.9027 2.125 14.5424 2.125 14.1667V6.375Z"
                                  stroke="#2C2C2C" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6.375 15.5833V8.5H10.625V15.5833" stroke="#2C2C2C" stroke-linecap="round"
                                  stroke-linejoin="round"/>
                        </svg>
                        Add Jobs </a>
                    </li>
                    <div class="col-auto ms-auto" style="padding-left: 600px; position: relative;">
                        <button id="shareAsPdf" class="btn btn-primary btn-sm"> Share As Pdf</button>
                        <div id="dropdown-container" class="dropdown-menu" style="display: none; position: absolute;">
                            <button class="dropdown-item btn btn-secondary btn-sm" id="equipmentQuotation"
                                    onclick="handleQuotation('Equipment')"
                                    style="color: #ffffff;"><i class="bi bi-file-earmark-pdf-fill"
                                                               style="color: red"></i> Equipment Quotation
                            </button>
                            <button class="dropdown-item btn btn-secondary btn-sm" id="totalQuotation"
                                    onclick="handleQuotation('Total')"
                                    style="color: #ffffff;"><i class="bi bi-file-earmark-pdf-fill"
                                                               style="color: red"></i> Total Quotation
                            </button>
                        </div>
                        <div id="porforma-options-container" style="display:none;">
                            <button id="porformaPrintOption" class="dropdown-item" style="text-align: center;"><i
                                    class="bi bi-printer-fill"></i> Print
                            </button>
                            <button id="porformaPdfOption" class="dropdown-item" style="text-align: center;"><i
                                    class="bi bi-file-fill"></i> PDF
                            </button>
                        </div>
                        <div id="prepsheet-options-container" style="display:none;">
                            <button id="prepsheetPrintOption" class="dropdown-item" style="text-align: center;"><i
                                    class="bi bi-printer-fill"></i> Print
                            </button>
                            <button id="prepsheetPdfOption" class="dropdown-item" style="text-align: center;"><i
                                    class="bi bi-file-fill"></i> PDF
                            </button>
                        </div>

                        <div id="delivery-options-container" style="display:none;">
                            <button id="printOption" class="dropdown-item" style="text-align: center;"><i
                                    class="bi bi-printer-fill"></i> Print
                            </button>
                            <button id="pdfOption" class="dropdown-item" style="text-align: center;"><i
                                    class="bi bi-file-fill"></i> PDF
                            </button>
                        </div>
                    </div>
                </ol>
            </div>

            <div class="form-container">
                <div class="step-buttons">
                    <button class="step-btn" onclick="showStep(1)" id="generalDetailsBtn">General Details</button>
                    <button class="step-btn" onclick="validateStep(1, 2)" id="addEquipmentBtn">Add Equipment</button>
                    <button class="step-btn" onclick="validateStep(1, 3)" id="addSubVendorBtn">Add Sub Vendor</button>
                    <button class="step-btn" onclick="validateStep(1, 4)" id="crewAllocationBtn">Crew Allocation
                    </button>
                    <button class="step-btn" onclick="validateStep(1, 5)" id="transportationBtn">Transportation</button>
                </div>

                <form id="multi-step-form">
                    {% csrf_token %}
                    <div class="form-step" id="step-1">
                        <div class="row">
                            <div class="col-xl-4 mb-3">
                                <label for="titleInput" class="form-label">Title</label>
                                <input type="text" class="form-control" id="titleInput" name="title"
                                       required>
                            </div>
                            <div class="col-xl-4 mb-3">
                                <div class="dropdown">
                                    <label for="venueAddressDropdown" class="form-label">Venue Name</label>
                                    <input type="text" class="form-control dropdown-toggle" id="venueAddressDropdown"
                                           data-bs-toggle="dropdown" aria-expanded="false"
                                           placeholder="Select Venue Name"
                                           autocomplete="off" name="venue_address">
                                    <ul class="dropdown-menu" aria-labelledby="venueAddressDropdown" id="dropdown-item">
                                        <!-- Dynamic options will be appended here -->
                                    </ul>
                                </div>
                            </div>
                            <div class="col-xl-4 mb-3">
                                <label for="venueAddressInput" class="form-label">Venue Address</label>
                                <input type="text" class="form-control" id="venueAddressInput"
                                       placeholder="Venue Address"
                                       name="venue_address" readonly>
                            </div>
                            <div class="col-xl-4 mb-3">
                                <div class="dropdown">
                                    <label for="clientNameDropdown" class="form-label">Client Name</label>
                                    <input type="text" class="form-control dropdown-toggle"
                                           id="clientNameDropdown"
                                           data-bs-toggle="dropdown" aria-expanded="false"
                                           placeholder="Select Client Name" autocomplete="off"
                                           name="client_name">
                                    <ul class="dropdown-menu" id="clientNameInputDropdown"
                                        aria-labelledby="clientNameDropdown">
                                        <!-- Dynamic options will be appended here -->
                                    </ul>
                                </div>
                            </div>
                            <div class="col-xl-4 mb-3">
                                <div class="dropdown">
                                    <label for="clientContactName" class="form-label">Contact Person Name</label>
                                    <select class="form-control" id="clientContactName" name="contact_person_name">

                                    </select>
                                </div>
                            </div>
                            <div class="col-xl-4 mb-3">
                                <div class="dropdown">
                                    <label for="clientContactNumber" class="form-label">Contact Person Number</label>
                                    <input type="text" class="form-control" id="clientContactNumber"
                                           placeholder="Contact Person Number"
                                           name="contact_person_number" readonly>
                                </div>
                            </div>
                            <div class="col-xl-3 mb-3">
                                <label for="preDate" class="form-label">Setup Date</label>
                                <input type="date" class="form-control" id="prepDate" name="setup_date" required>
                            </div>
                            <div class="col-xl-3 mb-3">
                                <label for="outDate" class="form-label">Rehearsal Date</label>
                                <input type="date" class="form-control" id="outDate" name="rehearsal_date" required>
                            </div>
                            <div class="col-xl-3 mb-3">
                                <label for="showStart" class="form-label">Event Date</label>
                                <input type="date" class="form-control" id="showStart" name="start_date" required>
                            </div>
                            <div class="col-xl-3 mb-3">
                                <label for="showEnd" class="form-label">Dismantle Date</label>
                                <input type="date" class="form-control" id="showEnd" name="end_date" required>
                            </div>
                            <div class="col-xl-3 mb-3">
                                <label class="form-label">Status</label>
                                <select class="default-select form-control" id="statusType"
                                        name="status">
                                    <option value="Quotation">Quotation</option>
                                    <option value="Proforma">Proforma</option>
                                    <option value="Prepsheet">Prepsheet</option>
                                    <option value="Delivery Challan">Delivery Challan</option>
                                </select>
                            </div>
                            <div class="col-xl-3 mb-3">
                                <label for="crewType" class="form-label">Crew Quantity</label>
                                <input type="text" class="form-control" id="crewQuantity"
                                       placeholder="Enter Quantity"
                                       name="crew_quantity" style="margin-top: -2px;">
                            </div>
                            <div class="col-xl-3 mb-3">
                                <label for="editInputNotes" class="form-label">Notes</label>
                                <input type="text" class="form-control" id="editInputNotes" placeholder="Enter Notes"
                                       name="input_notes">
                            </div>
                            <div class="col-xl-3 mb-3">
                                <label for="number_of_days" class="form-label">Number of
                                    Days</label>
                                <input type="number" class="form-control" id="number_of_days" name="total_days">
                            </div>
                            <div class="col-xl-3 mb-3" id="prepsheet-fields" style="display: none; width: 176px;">
                                <label class="form-label">Handler</label>
                                <select class="default-select form-control" id="employeeName" name="employee_name"
                                        multiple="multiple">
                                    <option value="" data-display="Select">Select</option>
                                </select>
                            </div>
                            <div class="row" id="quotation-fields1">
                                <div class="col-xl-3 mb-3">
                                    <label for="total_amount" class="form-label">Amount</label>
                                    <input type="number" class="form-control" id="total_amount"
                                           name="amount_row">
                                </div>
                                <div class="col-xl-3 mb-3">
                                    <label for="discount" class="form-label">Discount(%)</label>
                                    <input type="number" class="form-control" id="discount"
                                           name="discount">
                                </div>
                                <div class="col-xl-3 mb-3">
                                    <label for="discounted_amount" class="form-label">Amount After
                                        Discount</label>
                                    <input type="text" class="form-control" id="discounted_amount"
                                           name="discounted_amount">
                                </div>
                                <div class="col-xl-3 mb-3">
                                    <label for="total_amount_cal" class="form-label">Total Amount
                                        (18% GST)</label>
                                    <input type="number" class="form-control" id="total_amount_cal"
                                           name="total_amount">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-step" id="step-2">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="left-equipment-container">
                                    <div class="equipment">
                                        <div class="job" id="job-J06240001">
                                            <span class="toggle-sign"
                                                  style="cursor: pointer;">+</span>
                                            <span class="job-name" id="jobReferenceNo"></span>
                                        </div>

                                        <!-- New div for Equipment List heading with toggle sign -->
                                        <div id="heading-J06240001">
                                            <span class="equipment-heading">
                                                <span class="toggle-sign" style="cursor: pointer;"
                                                      id="createNewForm">+</span> Equipment List
                                            </span>
                                        </div>

                                        <div class="equipment-list" id="equipment-list-J06240001">
                                            <div class="equipment-item" id="equip-01">
                                                <span class="equipment-name"
                                                      data-equip-id="subEquipmentNo"
                                                      id="equipmentContainer"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Second Section -->
                            <div class="col-md-9">
                                <div class="right-equipment-container" id="rightEquipment"
                                     style="display: none;">
                                    <div class="row">
                                        <!-- Right Container: Table -->
                                        <div class="equipment-table-container"
                                             style="margin-top: 6px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="equipmentPopup" class="popup">
                        <div class="popup-content">
                            <div class="header-popup">
                                <h1>Equipment Selector</h1>
                            </div>
                            <div class="content-popup">
                                <table id="equipmentTable">
                                    <thead>
                                    <tr>
                                        <th style="width: 10%;">Qty</th>
                                        <th style="width: 30%;">Desc</th>
                                        <th style="width: 5%;">Av</th>
                                        <th style="width: 20%;">Unit Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td></td>
                                        <td>Audio - Sample Default Category</td>
                                        <td>0</td>
                                        <td>?0.00</td>
                                    </tr>

                                    </tbody>
                                </table>
                            </div>
                            <div class="footer-popup">
                                <input type="text" class="search-bar" placeholder="Search..."
                                       id="searchBar">
                                <button class="button" id="saveEquipmentList">OK</button>
                                <button class="button" id="cancelButton">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div id="equipmentInsertPopup" class="popup">
                        <div class="popup-content">
                            <div class="header-popup">
                                <h1>PopStock (Equipment Selector)</h1>
                            </div>
                            <div class="content-popup">
                                <table id="equipmentTable">
                                    <thead>
                                    <tr>
                                        <th style="width: 10%;">Qty</th>
                                        <th style="width: 30%;">Desc</th>
                                        <th style="width: 5%;">Av</th>
                                        <th style="width: 20%;">Unit Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td></td>
                                        <td>Audio - Sample Default Category</td>
                                        <td>0</td>
                                        <td>?0.00</td>
                                    </tr>

                                    </tbody>
                                </table>
                            </div>
                            <div class="footer-popup">
                                <input type="text" class="search-bar" placeholder="Search..."
                                       id="searchBarExisting">
                                <button class="button" id="existingSaveEquipmentList">OK</button>
                                <button class="button" id="cancelSaveEquipmentButton">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-step" id="step-3">
                        <h4>Add Sub Vendor</h4>
                        <div id="table-container">
                            <table id="sub-vendor-table" class="table">
                                <thead>
                                <tr>
                                    <th>Vendor Name</th>
                                    <th>Equipment Name</th>
                                    <th>Quantity</th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Rows will be dynamically added here -->
                                </tbody>
                            </table>
                            <button id="add-sub-vendor-row-btn" class="btn btn-primary" style="margin-top: 9px;">Add
                            </button>
                        </div>
                    </div>

                    <div class="form-step" id="step-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>Crew Allocation</h4>
                            <input type="text" class="form-control" id="searchCrew"
                                   placeholder="Search...."
                                   style="width: 200px;margin-bottom: 7px;">
                        </div>
                        <div class="table-responsive" id="crew-allocation-quotation">
                            <table class="table table-bordered table-responsive-sm">
                                <thead>
                                <tr>
                                    <th style="background-color: #170c0c; border-bottom: 2px solid #dee2e6;color: #ffffff;">
                                                            <span class="plus-icon" id="addCrewAllocationRow"
                                                                  style="cursor: pointer;">+</span>
                                    </th>
                                    <th style="width: 18%; background-color: #170c0c; border-bottom: 2px solid #dee2e6; color: #ffffff;">
                                        Crew Type
                                    </th>
                                    <th style="width: 10%; background-color: #170c0c; border-bottom: 2px solid #dee2e6; color: #ffffff;">
                                        No of Days
                                    </th>
                                    <th style="width: 11%; background-color: #170c0c; border-bottom: 2px solid #dee2e6; color: #ffffff;">
                                        Per Day
                                    </th>
                                    <th style="width: 12%; background-color: #170c0c; border-bottom: 2px solid #dee2e6; color: #ffffff;">
                                        Total
                                    </th>
                                    <th style="background-color: #170c0c; border-bottom: 2px solid #dee2e6;color: #ffffff;">
                                        Notes
                                    </th>
                                </tr>
                                </thead>
                                <tbody id="crew-allocation-table-body">
                                <!-- Master Category rows will be appended here by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <div class="table-responsive" id="crew-allocation-delivery-challan">
                            <table class="table table-bordered table-responsive-sm">
                                <thead>
                                <tr>
                                    <th style="background-color: #170c0c; border-bottom: 2px solid #dee2e6;color: #ffffff;">
                                                            <span class="plus-icon"
                                                                  id="addCrewAllocationDeliveryRow"
                                                                  style="cursor: pointer;">+</span>
                                    </th>
                                    <th style="width: 11%; background-color: #170c0c; border-bottom: 2px solid #dee2e6; color: #ffffff;">
                                        Crew Type
                                    </th>
                                    <th style="width: 16%; background-color: #170c0c; border-bottom: 2px solid #dee2e6; color: #ffffff;">
                                        Employee
                                    </th>
                                    <th style="width: 10%; background-color: #170c0c; border-bottom: 2px solid #dee2e6; color: #ffffff;">
                                        No of Days
                                    </th>
                                    <th style="width: 11%; background-color: #170c0c; border-bottom: 2px solid #dee2e6; color: #ffffff;">
                                        Per Day
                                    </th>
                                    <th style="width: 12%; background-color: #170c0c; border-bottom: 2px solid #dee2e6; color: #ffffff;">
                                        Total
                                    </th>
                                    <th style="background-color: #170c0c; border-bottom: 2px solid #dee2e6;color: #ffffff;">
                                        Notes
                                    </th>
                                </tr>
                                </thead>
                                <tbody id="crew-allocation-delivery-table-body">
                                <!-- Master Category rows will be appended here by JavaScript -->
                                </tbody>
                            </table>
                        </div>


                    </div>

                    <div class="form-step" id="step-5">
                        <h4>Transportation Allocation</h4>
                        <div class="mb-3">
                            <div class="d-flex">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="radio" name="transportation_type"
                                           id="onVehicle" value="on_vehicle">
                                    <label class="form-check-label" for="onVehicle">Own Vehicle</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="transportation_type"
                                           id="outsideVehicle" value="outside_vehicle">
                                    <label class="form-check-label" for="outsideVehicle">Outside Vehicle</label>
                                </div>
                            </div>
                        </div>
                        <!-- Container for "Own Vehicle" details -->
                        <div id="onVehicleFields" class="transportation-fields"></div>

                        <!-- Container for "Outside Vehicle" details -->
                        <div id="outsideVehicleFields" class="transportation-fields"></div>

                        <div>
                            <button class="btn btn-primary light ms-1" id="addTransportation">Add More</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!--**********************************
        Main wrapper end
        ***********************************-->
        {% include 'product_tracking/footer.html' %}
    </div>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <meta name="csrf-token" content="{{ csrf_token }}">

    </body>
{% endblock %}
